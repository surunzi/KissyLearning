/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 13 11:53
*/
KISSY.add("router","util,logger-manager,./router/utils,./router/route,url,./router/request,event/dom,event/custom,feature".split(","),function(u,f,c){function o(g,a){var e=l.addVid("#!"+g+(B?"":a?v.REPLACE_HISTORY:""),p);a?location.replace(e):location.hash=e}function i(g){var g=g||location.href,a=q.parse(g);return!m.useHash&&n?a.pathname.substr(m.urlRoot.length)+(a.search||""):l.getHash(g)}function k(g,a,e){function b(){d++;if(d===c)e(g,a);else{var h=r[d];if(x.startsWith(g.path+"/",h[0]+"/")){var f=
h[0].length;g.url=g.url.slice(f);var l=g.path;g.path=g.path.slice(f);h[1](g,b);g.url=g.originalUrl;g.path=l}else b()}}var d=-1,c=r.length;b()}function j(g,a){function e(){b++;if(b!==d){var c=h[b];if(g.params=c.match(g.path)){var f=-1,l=c.callbacks,k=l.length,i=function(b){if(b==="route"){i=null;e()}else{f++;if(f!==k){g.route=c;l[f](g,a,i)}}};i("")}else e()}}var b=-1,d=h.length;e()}function b(g,a){var e=i(),b=q.parse(e,true),d=b.query;b.search="";b.query={};b=q.stringify(b)||"/";e=new C({query:d,backward:g===
true,replace:a===true,forward:g===false&&a===false,path:b,url:e,originalUrl:e});d={redirect:c.navigate};c.fire("dispatch",{request:e,response:d});k(e,d,j)}function a(a){var d=false,e=false;if(a===s[s.length-2]){d=true;s.pop()}else a!==s[s.length-1]?s.push(a):e=true;b(d,e)}function d(g){(g=g.originalEvent.state)&&a(g.vid)}function z(g){(g=A(g.newURL||location.href))&&a(g)}var x=f("util"),D=f("logger-manager"),r=[],h=[],l=f("./router/utils"),E=f("./router/route"),q=f("url"),C=f("./router/request"),
v=f("event/dom"),u=f("event/custom"),A=l.getVidFromUrlWithHash,w=window,t=w.history,B=f("feature").isHashChangeSupported(),n=!(!t||!t.pushState),p=10,s=[p],m={urlRoot:"",useHash:!n};x.mix(c,u.Target);c.use=function(a,b){if(typeof a!=="string"){b=a;a=""}r.push([a,b])};c.navigate=function(a,d){var d=d||{},e=d.replace||false,c=i(),f=q.parse(c);if(a.charAt(0)==="?"){f.search=a;a=q.stringify(f)}if(c!==a){if(!e){p++;s.push(p)}if(!m.useHash&&n){t[e?"replaceState":"pushState"]({vid:p},"",l.getFullPath(a,
m.urlRoot));b(false,e)}else if(n){t[e?"replaceState":"pushState"]({vid:p},"","#!"+a);b(false,e)}else o(a,e)}else d&&d.triggerRoute&&b(false,true)};c.get=function(a){var b=x.makeArray(arguments).slice(1);h.push(new E(a,b,m))};c.matchRoute=function(a){for(var b=0,d=h.length;b<d;b++)if(h[b].match(a))return h[b];return false};c.removeRoute=function(a,b){for(var d=h.length-1;d>=0;d--){var c=h[d];if(c.path===a)if(b){c.removeCallback(b);c.callbacks.length||h.splice(d,1)}else h.splice(d,1)}};c.clearRoutes=
function(){r=[];h=[]};c.hasRoute=function(a){for(var b=0,d=h.length;b<d;b++)if(h[b].path===a)return h[b];return false};c.config=function(a){if(a.urlRoot)a.urlRoot=a.urlRoot.replace(/\/$/,"");x.mix(m,a)};var y;c.start=function(a){if(y)return a&&a.call(c);var f=m.useHash,e=m.urlRoot,h=m.triggerRoute,k=location.pathname,j=location.href,r=i(),q=location.hash.match(/#!.+/);if(!f)if(n){if(q)if(e)if(l.equalsIgnoreSlash(k,e)){t.replaceState({},"",j=l.getFullPath(r,e));h=1}else D.error("router: location path must be same with urlRoot!");
else{e=location.hash.substring(2);e[0]==="/"&&(e=e.substring(1));t.replaceState({},"",j=location.protocol+"//"+location.host+location.pathname+e);h=1}}else if(l.equalsIgnoreSlash(k,e))f=true;else{location.replace(l.addEndSlash(e)+"#!"+r);return}setTimeout(function(){var e=n;if(n)v.on(w,"popstate",d);else{v.on(w,"hashchange",z);h=1}if(f)if(i())if(!n&&A(j)!==p){o(l.getHash(j),true);h=0}else n&&l.hasVid(j)&&location.replace(j=l.removeVid(j));else{c.navigate("/",{replace:true});h=0;e=false}e&&t.replaceState({vid:p},
"",j);h&&b(false,true);a&&a(c)},100);y=true;return c};c.Utils=l;c.stop=function(){y=false;v.detach(w,"hashchange",z);v.detach(w,"popstate",d)}});
KISSY.add("router/utils",["event/dom"],function(u,f,c,o){function i(a){return a.replace(/__ks-vid=.+$/,"")}function k(a){var b;return(b=a.match(/__ks-vid=(.+)$/))?parseInt(b[1],10):0}function j(a){return(a=a.match(/#(.+)$/))&&a[1]||""}var b=f("event/dom");o.exports={endWithSlash:function(a){return"/"===a.charAt(a.length-1)},startWithSlash:function(a){return"/"===a.charAt(0)},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&
(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,b){return location.protocol+"//"+location.host+this.removeEndSlash(b)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,b){a=this.removeEndSlash(a);b=this.removeEndSlash(b);return a===b},getHash:function(a){return i(j(a).replace(/^!/,"")).replace(b.REPLACE_HISTORY,"")},removeVid:i,hasVid:function(a){return-1!==a.indexOf("__ks-vid=")},
addVid:function(a,b){return a+"__ks-vid="+b},getVidFromUrlWithHash:function(a){return k(j(a))},getVidFromHash:k}});
KISSY.add("router/route",["util"],function(u,f,c,o){function i(b,a,d,c){j.isArray(b)&&(b="("+b.join("|")+")");b=b.concat(d?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(b,d,c,f,j,k,i){a.push(f);d=d||"";return""+(k?"":d)+"(?:"+(k?d:"")+(c||"")+(j||c&&"([^/.]+?)"||"([^/]+?)")+")"+(k||"")+(i?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return{keys:a,regexp:RegExp("^"+b+"$",c?"":"i")}}function k(b,a,d){this.path=b;this.callbacks=a;this.keys=
[];"string"===typeof b||j.isArray(b)?j.mix(this,i(b,this.keys,d.strict,d.caseSensitive)):this.regexp=b}var j=f("util");k.prototype={match:function(b){b=b.match(this.regexp);if(!b)return!1;for(var a=this.keys,d=[],c=1,f=b.length;c<f;++c){var k=a[c-1],i="string"===typeof b[c]?j.urlDecode(b[c]):b[c];k?d[k]=i:d.push(i)}return d},removeCallback:function(b){for(var a=this.callbacks||[],d=a.length-1;0<=d;d++)a===b&&a.splice(d,1)}};o.exports=k});
KISSY.add("router/request",[],function(u,f,c,o){function i(c){for(var f in c)this[f]=c[f]}i.prototype={param:function(c){return c in this.params?this.params[c]:this.query[c]}};o.exports=i});

/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 13 11:41
*/
KISSY.add("combobox/multi-word",["./multi-word/cursor","combobox"],function(l,f,s,o){function k(a,c){return c&&-1!==a.indexOf(c)}function g(a){a.newVal&&a.target===this.get("menu")&&this.alignWithCursor()}function h(a){var c=a.get("input"),e=a.get("value"),b=[],d=[],q=a.get("literal"),r=a.get("separator"),a=a.get("separatorType"),h=!1,m=a!==j,c=c.prop("selectionStart"),f,i,g=-1;for(f=0;f<e.length;f++)(i=e.charAt(f),q&&i===q&&(h=!h),h)?d.push(i):(f===c&&(g=b.length),m&&n.test(i))?(d.length&&b.push(d.join("")),
d=[],d.push(i)):k(r,i)?a===j?(d.push(i),d.length&&b.push(d.join("")),d=[]):(d.length&&b.push(d.join("")),d=[],d.push(i)):d.push(i);d.length&&b.push(d.join(""));b.length||b.push("");-1===g&&(a===j&&k(r,i)&&b.push(""),g=b.length-1);return{tokens:b,cursorPosition:c,tokenIndex:g}}var j="suffix",n=/\s|\xa0/,p=f("./multi-word/cursor"),l=f("combobox");o.exports=l.extend({syncUI:function(){var a;this.get("alignWithCursor")&&(a=this.get("menu"),a.setInternal("align",null),a.on("beforeVisibleChange",g,this))},
getCurrentValue:function(){var a=h(this),c=a.tokens,e=a.tokenIndex,a=this.get("separator"),b=this.get("separatorType"),c=c[e],e=c.length-1;if(b!==j)if(k(a,c.charAt(0)))c=c.slice(1);else return;else b===j&&k(a,c.charAt(e))&&(c=c.slice(0,e));return c},setCurrentValue:function(a,c){var e=this.get("input"),b=h(this),d=b.tokens,b=Math.max(0,b.tokenIndex),f=this.get("separator"),g;g=this.get("separatorType");var l=d[b+1]||"",m=d[b];if(g!==j){if(d[b]=m.charAt(0)+a,a&&(!l||!n.test(l.charAt(0))))d[b]+=" "}else d[b]=
a,g=m.length-1,k(f,m.charAt(g))?d[b]+=m.charAt(g):1===f.length&&(d[b]+=f);b=d.slice(0,b+1).join("").length;this.set("value",d.join(""),c);e.prop("selectionStart",b);e.prop("selectionEnd",b)},alignWithCursor:function(){var a=this.get("menu"),c;c=this.get("input");c=p(c);a.move(c.left,c.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:j},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})});
KISSY.add("combobox/multi-word/cursor",["util","node"],function(l,f,s,o){function k(a){var c=n;c||(c=h(j));"textarea"===""+a[0].type.toLowerCase()?c.css("width",a.css("width")):c.css("width",9999);g.each(p,function(e){c.css(e,a.css(e))});n||c.insertBefore(a[0].ownerDocument.body.firstChild);return n=c}var g=f("util"),h=f("node"),j='<div style="z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;"></div>',n,p="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
o.exports=function(a){var c=h(a),a=c[0],e=a.ownerDocument,b=h(e),d=a.scrollTop,f=a.scrollLeft;if(e.selection)return a=e.selection.createRange(),{left:a.boundingLeft+f+b.scrollLeft(),top:a.boundingTop+d+a.boundingHeight+b.scrollTop()};b=c.offset();if("textarea"!==a.type)return b.top+=a.offsetHeight,b;e=k(c);c=a.selectionStart;e.html(g.escapeHtml(a.value.substring(0,c-1))+"<span>x</span>");e.offset(b);b=e.last();a=b.offset();a.top+=b.height();0<c&&(a.left+=b.width());a.top-=d;a.left-=f;return a}});

/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 13 11:58
*/
KISSY.add("editor","util,logger-manager,node,xtemplate/runtime,editor/iframe-content-xtpl,editor/base,editor/utils,editor/focus-manager,editor/clipboard,editor/enter-key,editor/html-data-processor,editor/selection-fix,editor/styles,editor/dom-iterator,editor/z-index-manager,ua".split(","),function(x,f,C,y){function s(v,a){var n=v.get("textarea"),c=v.get("toolBarEl"),b=v.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(b&&b.outerHeight()||0));n.parent().css(A,a);n.css(A,a)}function r(v,
a){var n=v.body;J(function(){v.designMode="on";setTimeout(function P(){v.designMode="off";n.focus();if(!P.retry)P.retry=m},50)},function(){v.designMode="off";n.setAttribute("contentEditable",false);n.setAttribute("contentEditable",true);a||r(v,1)})}function o(v){var a=v.get("textarea")[0],n=v.get("window"),b=v.get("document"),e=b[0];if(i.webkit){b.on("click",function(v){var a=d(v.target);w.inArray(a.nodeName(),["input","select"])&&v.preventDefault()});b.on("mouseup",function(v){var a=d(v.target);
w.inArray(a.nodeName(),["input","textarea"])&&v.preventDefault()})}if(i.gecko||i.ie){var m;m=d('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>').insertAfter(a);m.on("focus",function(){v.focus()});v.activateGecko=function(){i.gecko&&v.__iframeFocus&&m[0].focus()};v.on("destroy",function(){m.detach();m.remove()})}n.on("focus",function(){i.gecko&&r(e,k);v.notifySelectionChange()});if(i.gecko)b.on("mousedown",function(){v.__iframeFocus||r(e,k)});if(H){b.on("keydown",
function(a){if(a.keyCode in{8:1,46:1}){var n=v.getSelection(),b=n.getSelectedElement();if(b){v.execCommand("save");var c=n.getRanges()[0].createBookmark();b.remove();n.selectBookmarks([c]);v.execCommand("save");a.preventDefault()}}});if(e.compatMode==="CSS1Compat"){var g={33:1,34:1};b.on("keydown",function(a){a.keyCode in g&&setTimeout(function(){v.getSelection().scrollIntoView()},0)})}}if(i.webkit)b.on("mousedown",function(a){a=d(a.target);w.inArray(a.nodeName(),["img","hr","input","textarea","select"])&&
v.getSelection().selectElement(a)});if(i.gecko)b.on("dragstart",function(v){var a=d(v.target);a.nodeName()==="img"&&/ke_/.test(a[0].className)&&v.preventDefault()});c.add(v)}function u(v,a,n,b){var c="",e;e=g.debugUrl("theme/iframe.css");n=n.concat([]);n.unshift(e);for(e=0;e<n.length;e++)c=c+w.substitute('<link href="{href}" rel="stylesheet" />',{href:n[e]});return(new z(t)).render({doctype:i.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:c,style:"<style>"+
a+"</style>",data:b||"",script:v?'<script id="ke_active_script">'+(d(window).isCustomDomain()?'document.domain="'+document.domain+'";':"")+"parent.KISSY.require('editor')._initIframe(\""+v+'");<\/script>':""})}function j(v,a){function n(){g=m.document;v.setInternal("document",d(g));v.setInternal("window",d(m));b.detach();g.open("text/html","replace");g.write(c);g.close()}var b=v.get("iframe"),c=u(v.get("id"),v.get("customStyle"),v.get("customLink"),a),e=b[0],m=e.contentWindow,g;b.__loaded=1;try{g=
m.document}catch(k){e.src=e.src;if(H<7){setTimeout(n,10);return}}n()}function h(v,a){var n=d(window).getEmptyIframeSrc()||"";n&&(n=' src="'+n+'" ');var n=d(w.substitute(F,{iframeSrc:n,prefixCls:v.get("prefixCls")})),b=v.get("textarea");b.hasAttr("tabindex")&&n.attr("tabindex",i.webkit?-1:b.attr("tabindex"));b.parent().prepend(n);v.set("iframe",n);v.__docReady=0;if(i.gecko&&!n.__loaded)n.on("load",function(){j(v,a)},v);else j(v,a)}function l(v){if(v.get("iframe")){var a=v.get("iframe"),n=v.get("window"),
v=v.get("document"),b=v[0],c=d(b.documentElement),b=d(b.body);w.each([v,c,b,n],function(v){v.detach()});a.remove()}}var w=f("util");f("logger-manager");var d=f("node"),z=f("xtemplate/runtime"),t=f("editor/iframe-content-xtpl"),q=f("editor/base"),g=f("editor/utils"),c=f("editor/focus-manager"),p=f("editor/clipboard"),e=f("editor/enter-key"),a=f("editor/html-data-processor"),b=f("editor/selection-fix");f("editor/styles");f("editor/dom-iterator");f("editor/z-index-manager");y.exports=q;var m=true,k=
false,i=f("ua"),H=i.ieMode<11,I=d.Dom.NodeType,A="height",J=g.tryThese,F='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',n=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;q.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};var D=w.buffer(function(){this.execCommand("save")},50);q.addMembers({initializer:function(){this.__commands={};this.__controls={};c.register(this)},renderUI:function(){p.init(this);e.init(this);a.init(this);
b.init(this)},bindUI:function(){function v(){a.detach("docReady",v);if(a.get("focused"))a.focus();else{var n=a.getSelection();n&&n.removeAllRanges()}}var a=this,n,b=a.get("prefixCls"),c=a.get("textarea");if(a.get("attachForm")&&(n=c[0].form)&&(n=d(n)))n.on("submit",a.sync,a);a.on("docReady",v);a.on("blur",function(){a.$el.removeClass(b+"editor-focused")});a.on("focus",function(){a.$el.addClass(b+"editor-focused")})},syncUI:function(){s(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},
getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,n){this.__controls[a]=n},showDialog:function(a,n){var a=a+"/dialog",b=this.__controls[a];b.show(n);this.fire("dialogShow",{dialog:b.dialog,pluginDialog:b,dialogName:a})},addCommand:function(a,n){this.__commands[a]=n},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var n=this.__commands[a],b=w.makeArray(arguments);b.shift();b.unshift(this);if(n)return n.exec.apply(n,
b)},queryCommandValue:function(a){return this.execCommand(g.getQueryCmd(a))},setData:function(a){var n,b=a;if(this.get("mode")!==1)this.get("textarea").val(a);else{if(n=this.htmlDataProcessor)b=n.toDataFormat(a);l(this);h(this,b)}},getData:function(a,b){var c=this.htmlDataProcessor,e;b===void 0&&(b=this.get("mode"));e=b===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());e=a?c.toHtml(e):c.toServer(e);e=w.trim(e);n.test(e)&&(e="");return e},getFormatData:function(a){return this.getData(1,
a)},getDocHtml:function(){return u(0,this.get("customStyle"),this.get("customLink"),this.getFormatData())},getSelection:function(){return q.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],n="";if(a){a=a.cloneContents();n=this.get("document")[0].createElement("div");n.appendChild(a);n=n.innerHTML}return n},focus:function(){var a=this.get("window");if(a){var n=this.get("document")[0],a=a[0];i.ie||a&&a.parent&&a.parent.focus();a&&a.focus();
try{n.body.focus()}catch(b){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,n){var b=this.get("window"),c=this.get("customStyle")||"";this.set("customStyle",c+("\n"+a));b&&b.addStyleSheet(a,n)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var n=this.get("customLink"),b=this.get("document")[0];n.push(a);this.set("customLink",n);n=b.createElement("link");n.rel=
"stylesheet";b.getElementsByTagName("head")[0].appendChild(n);n.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(n){n.attr("href")===a&&n.remove()});var n=this.get("customLink"),b=w.indexOf(a,n);b!==-1&&n.splice(b,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=
setTimeout(function(){var n=a.getSelection();if(n&&!n.isInvalid){var b=n.getStartElement(),c=new q.ElementPath(b);if(!a.__previousPath||!a.__previousPath.compare(c)){a.__previousPath=c;a.fire("selectionChange",{selection:n,path:c,element:b})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===1){this.focus();var n,b=a.nodeName(),c=q.XHTML_DTD,e=c.$block[b],g=q.RangeType,k=(b=this.getSelection())&&b.getRanges(),
i,d,p;if(k&&k.length!==0){this.execCommand("save");for(d=k.length-1;d>=0;d--){i=k[d];n=!d&&a||a.clone(m);i.insertNodeByDtd(n);p||(p=n)}if(p){i.moveToPosition(p,g.POSITION_AFTER_END);if(e){a=q.Walker.whitespaces(true);(a=(p=p.next(a,1))&&p[0].nodeType===I.ELEMENT_NODE&&p.nodeName())&&c.$block[a]&&c[a]["#text"]&&i.moveToElementEditablePosition(p)}b.selectRanges([i]);this.focus();n&&n[0].nodeType===1&&n.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});D.call(this);
return n}}}},insertHtml:function(a,n){var b=this,c,e=b.get("document")[0];if(b.get("mode")===1){if(c=b.htmlDataProcessor)a=c.toDataFormat(a,n);b.focus();b.execCommand("save");if(c=e.selection){c.type==="Control"&&c.clear();try{c.createRange().pasteHTML(a)}catch(m){}}else{c=b.get("iframe")[0].contentWindow.getSelection();var g=c.getRangeAt(0);g.deleteContents();var k=e.createElement("div");k.innerHTML=a;for(var e=e.createDocumentFragment(),i,d;i=k.firstChild;)d=e.appendChild(i);g.insertNode(e);if(d){g=
g.cloneRange();g.setStartAfter(d);g.collapse(true);c.removeAllRanges();c.addRange(g)}}setTimeout(function(){b.getSelection().scrollIntoView()},50);D.call(b)}},_onSetHeight:function(a){s(this,a)},_onSetMode:function(a){var n=this.get("iframe"),b=this.get("textarea");if(a===1){this.setData(b.val());b.hide();this.fire("wysiwygMode")}else{if(n){b.val(this.getFormatData(1));n.hide()}b.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,
n=this.get("textarea"),b=this.get("document");this.get("attachForm")&&(a=n[0].form)&&(a=d(a))&&a.detach("submit",this.sync,this);if(b){a=d(b[0].body);var n=d(b[0].documentElement),e=this.get("window");c.remove(this);b.detach();n.detach();a.detach();e.detach()}w.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});q.decorate=function(a,n){var n=n||{},a=d(a),b=n.textareaAttrs=n.textareaAttrs||{},c=a.style("width"),e=a.style("height"),g=a.attr("name");if(c)n.width=
n.width||c;if(e)n.height=n.height||e;if(g)b.name=g;n.data=n.data||a.val();n.elBefore=a;b=(new q(n)).render();a.remove();return b};q._initIframe=function(a){var n=c.getInstance(a),a=n.get("document"),b=a[0];a.one("#ke_active_script").remove();o(n);var e=b.body,g=d(e);if(H){e.hideFocus=m;e.disabled=m;e.contentEditable=m;e.removeAttribute("disabled")}else setTimeout(function(){i.gecko?e.contentEditable=m:i.webkit?e.parentNode.contentEditable=m:b.designMode="on"},0);if(i.gecko){var D=b.documentElement;
d(D).on("mousedown",function(a){if(a.target===D){i.gecko&&r(b,k);n.activateGecko()}})}setTimeout(function(){H&&setTimeout(function(){if(b){e.runtimeStyle.marginBottom="0px";e.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){n.__docReady=1;n.fire("docReady");var a=n.get("disableObjectResizing"),c=n.get("disableInlineTableEditing");if(a||c)try{b.execCommand("enableObjectResizing",k,!a);b.execCommand("enableInlineTableEditing",k,!c)}catch(e){g.on(H?"resizestart":"resize",function(n){var b=
d(n.target);(a||b.nodeName()==="table"&&c)&&n.preventDefault()})}},10)}});
KISSY.add("editor/iframe-content-xtpl",[],function(x,f,C,y){x=function(f,r){r.write("<!doctype html>\r\n<html>\r\n<head>",0);var o=f.resolve(["doctype"],0);r.write(o,!1);r.write("\r\n    <title>",0);o=f.resolve(["title"],0);r.write(o,!1);r.write("</title>\r\n    ",0);o=f.resolve(["style"],0);r.write(o,!1);r.write("\r\n    ",0);o=f.resolve(["links"],0);r.write(o,!1);r.write('\r\n    </head> \r\n<body class="ks-editor">\r\n',0);o=f.resolve(["data"],0);r.write(o,!1);r.write("\r\n",0);o=f.resolve(["script"],
0);r.write(o,!1);r.write("\r\n</body> \r\n</html>",0);return r};x.TPL_NAME=y.name;x.version="5.0.0";y.exports=x});
KISSY.add("editor/base",["util","ua","html-parser","component/control","./render-xtpl"],function(x,f,C,y){var s=f("util"),r=f("ua"),x=f("html-parser"),C=f("component/control"),f=f("./render-xtpl");y.exports=C.extend({beforeCreateDom:function(f){s.mix(f,{mobile:r.mobile})}},{Config:{},XHTML_DTD:x.DTD,ATTRS:{contentTpl:{value:f},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+
this.getBaseCssClass("tools")}},statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},handleGestureEvents:{value:!1},focusable:{value:!1},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/render-xtpl",[],function(x,f,C,y){x=function(f,r){var o=this.root.nativeCommands,u=o.each,o=o["if"];r.write('<div class="',0);var j=f.resolve(["prefixCls"],0);r.write(j,!0);r.write('editor-tools">\r\n\r\n</div>\r\n\r\n<\!--\r\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\r\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\r\n--\>\r\n\r\n<div class="',0);j=f.resolve(["prefixCls"],0);r.write(j,!0);r.write('editor-textarea-wrap"\r\n\r\n',0);var j={escape:1},h=[],l=f.resolve(["mobile"],0);h.push(l);
j.params=h;j.fn=function(h,d){d.write('\r\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\r\n',0);return d};r=o.call(this,f,j,r,12);r.write('\r\n>\r\n\r\n<textarea class="',0);j=f.resolve(["prefixCls"],0);r.write(j,!0);r.write('editor-textarea"\r\n\r\n',0);j={escape:1};h=[];l=f.resolve(["textareaAttrs"],0);h.push(l);j.params=h;j.fn=function(h,d){d.write("\r\n",0);var l=h.resolve(["xindex"],0);d.write(l,!0);d.write('="',0);l=h.resolve(["this"],0);d.write(l,!0);d.write('"\r\n',0);return d};
r=u.call(this,f,j,r,19);r.write("\r\n\r\n",0);u={escape:1};j=[];h=f.resolve(["mode"],0);j.push(h);u.params=j;u.fn=function(h,d){d.write('\r\nstyle="display:none"\r\n',0);return d};r=o.call(this,f,u,r,23);r.write("\r\n\r\n>",0);o=f.resolve(["data"],0);r.write(o,!0);r.write('</textarea>\r\n\r\n</div>\r\n\r\n<div class="',0);o=f.resolve(["prefixCls"],0);r.write(o,!0);r.write('editor-status">\r\n\r\n</div>',0);return r};x.TPL_NAME=y.name;x.version="5.0.0";y.exports=x});
KISSY.add("editor/utils",["util","node","./base","dom","ua"],function(x,f,C,y){var s=f("util"),r=f("node"),x=f("./base"),o=f("dom"),u=f("ua"),j={debugUrl:function(h){var l=y.getPackage()&&y.getPackage().getFilter(),j=y.getTag();l&&(h=h.replace(/\.(js|css)/i,"-"+l+".$1"));j&&(h=-1!==h.indexOf("?")?h+("&t="+j):h+("?t="+j));KISSY.DEV_MODE&&(h=h.replace(/^theme\//,"theme/assets/"));return f.toUrl((KISSY.DEV_MODE?"../../sub-modules/":"./")+h)},lazyRun:function(h,l,f){var d=h[l],j=h[f];h[l]=function(){d.apply(this,
arguments);h[l]=h[f];return j.apply(this,arguments)}},getXY:function(h,l){var f=h.left,d=h.top,j=l.get("window")[0],f=f-o.scrollLeft(j),d=d-o.scrollTop(j),j=l.get("iframe").offset(),f=f+j.left,d=d+j.top;return{left:f,top:d}},tryThese:function(){for(var h,l=0,f=arguments.length;l<f;l++){var d=arguments[l];try{h=d();break}catch(j){}}return h},clearAllMarkers:function(h){for(var l in h)h[l]._4eClearMarkers(h,!0,void 0)},ltrim:function(h){return h.replace(/^\s+/,"")},rtrim:function(h){return h.replace(/\s+$/,
"")},isNumber:function(h){return/^\d+(.\d+)?$/.test(s.trim(h))},verifyInputs:function(h){for(var l=0;l<h.length;l++){var f=r(h[l]),d=s.trim(j.valInput(f)),o=f.attr("data-verify"),f=f.attr("data-warning");if(o&&!RegExp(o).test(d))return alert(f),!1}return!0},sourceDisable:function(h,l){h.on("sourceMode",l.disable,l);h.on("wysiwygMode",l.enable,l)},resetInput:function(h){var l=h.attr("placeholder");l&&u.ie?(h.addClass("ks-editor-input-tip"),h.val(l)):u.ie||h.val("")},valInput:function(h,l){if(void 0===
l)return h.hasClass("ks-editor-input-tip")?"":h.val();h.removeClass("ks-editor-input-tip");h.val(l)},placeholder:function(h,l){h.attr("placeholder",l);u.ie&&(h.on("blur",function(){s.trim(h.val())||(h.addClass("ks-editor-input-tip"),h.val(l))}),h.on("focus",function(){h.removeClass("ks-editor-input-tip");s.trim(h.val())===l&&h.val("")}))},normParams:function(h){var h=s.clone(h),l;for(l in h){var f=h[l];"function"===typeof f&&(h[l]=f())}return h},preventFocus:function(h){u.ie?h.unselectable():h.attr("onmousedown",
"return false;")},injectDom:function(h){s.mix(o,h);for(var f in h)(function(f){r.prototype[f]=function(){var d=[].slice.call(arguments,0);d.unshift(this[0]);return(d=h[f].apply(null,d))&&(d.nodeType||s.isWindow(d))?r(d):s.isArray(d)&&(d.__IS_NODELIST||d[0]&&d[0].nodeType)?r(d):d}})(f)},addRes:function(){var h=this.__res=this.__res||[];h.push.apply(h,s.makeArray(arguments))},destroyRes:function(){for(var h=this.__res||[],f=0;f<h.length;f++){var j=h[f];"function"===typeof j?j():j.destroy?j.destroy():
j.remove&&j.remove()}this.__res=[]},getQueryCmd:function(f){return"query"+("-"+f).replace(/-(\w)/g,function(f,h){return h.toUpperCase()})+"Value"}};x.Utils=j;y.exports=j});
KISSY.add("editor/focus-manager",["./base"],function(x,f,C,y){function s(){var d=this;d.__iframeFocus=h;j=d;u&&clearTimeout(u);u=setTimeout(function(){d.fire("focus")},30)}function r(){var d=this;d.__iframeFocus=l;j=w;u&&clearTimeout(u);u=setTimeout(function(){d.fire("blur")},30)}var x=f("./base"),o={},u,j,h=!0,l=!1,w=null,y=y.exports={currentInstance:function(){return j},getInstance:function(d){return o[d]},register:function(d){o[d.get("id")]=d},add:function(d){this.register(d);d.get("window").on("focus",
s,d).on("blur",r,d)},remove:function(d){delete o[d.get("id")];d.get("window").detach("focus",s,d).detach("blur",r,d)}};x.focusManager=y;x.getInstances=function(){return o}});
KISSY.add("editor/clipboard","util,logger-manager,./base,./range,./selection,node,ua".split(","),function(x,f,C){function y(a,b){var c=a.get("document")[0],e=d(c.body),g=false,p=function(){g=true};e.on(b,p);(z.ieMode>7?c:c.selection.createRange()).execCommand(b);e.detach(b,p);return g}function s(a){this.editor=a;this._init()}function r(a){var b=a.get("document")[0],c=a.getSelection(),e;if(c.getType()===w.SELECTION_ELEMENT&&(e=c.getSelectedElement())){var a=c.getRanges()[0],g=d(b.createTextNode(""));
g.insertBefore(e);a.setStartBefore(g);a.setEndAfter(e);c.selectRanges([a]);setTimeout(function(){if(e.parent()){g.remove();c.selectElement(e)}},0)}}function o(a){if(z.webkit){if(!a.match(/^[^<]*$/g)&&!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(z.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(z.gecko){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function u(a){a=a.replace(/\s+/g,
" ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(z.webkit&&a.indexOf("<div>")>-1){if(a.match(/<div>(?:<br>)?<\/div>/)){a=a.replace(/<div>(?:<br>)?<\/div>/g,function(){return"<p></p>"});a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")}a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"))}else if(z.gecko){z.gecko&&(a=a.replace(/^<br><br>$/,
"<br>"));a.indexOf("<br><br>")>-1&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>")}return a}function j(a){var b=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/gi,"");if(a.indexOf("Apple-")!==-1){a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," ");a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,b){return b.replace(/\t/g,Array(5).join("&nbsp;"))});if(a.indexOf('<br class="Apple-interchange-newline">')>-1){b=1;a=a.replace(/<br class="Apple-interchange-newline">/,
"")}a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1")}!b&&o(a)&&(a=u(a));return a}x=f("util");f("logger-manager");var h=f("./base"),l=f("./range"),w=f("./selection"),d=f("node"),z=f("ua"),t=z.ieMode<11,q=t?"beforepaste":"paste",g=h.RangeType,c=t?function(a,b){return y(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(c){return false}},p={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"};
x.augment(s,{_init:function(){var a=this,b=a.editor,e=b.get("document"),g=e.one("body"),i=function(a){this.type=a};i.prototype={exec:function(b){var e=this.type;b.focus();setTimeout(function(){if(t)if(e==="cut")r(b);else if(e==="paste"){a._preventPasteEvent();a._getClipboardDataFromPasteBin()}c(b,e)||alert(p[e])},0)}};g.on(q,a._getClipboardDataFromPasteBin,a);if(t){g.on("paste",a._iePaste,a);e.on("keydown",a._onKeyDown,a);e.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=
0},0)})}b.addCommand("copy",new i("copy"));b.addCommand("cut",new i("cut"));b.addCommand("paste",new i("paste"))},_onKeyDown:function(a){this.editor.get("mode")===h.Mode.WYSIWYG_MODE&&(a.ctrlKey&&a.keyCode===86||a.shiftKey&&a.keyCode===45)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var b,c=this.editor;if(a==="paste"){this._isPreventBeforePaste=1;try{b=c.get("document")[0].queryCommandEnabled(a)}catch(e){}this._isPreventBeforePaste=0}else b=(a=(a=c.getSelection())&&a.getRanges())&&
!(a.length===1&&a[0].collapsed);return b},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var b=this.editor;if(!this._isPreventPaste){a.preventDefault();b.execCommand("paste")}},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,b=a.get("document")[0];if(!b.getElementById("ke-paste-bin")){var c=a.getSelection(),
e=new l(b),i=d(z.webkit?"<body></body>":"<div></div>",b);i.attr("id","ke-paste-bin");z.webkit&&i[0].appendChild(b.createTextNode("\u200b"));b.body.appendChild(i[0]);i.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});i.css("left","-1000px");var p=c.createBookmarks();e.setStartAt(i,g.POSITION_AFTER_START);e.setEndAt(i,g.POSITION_BEFORE_END);e.select(true);setTimeout(function(){var b,e=i;i=z.webkit&&(b=i.first())&&b.hasClass("Apple-style-span")?
b:i;c.selectBookmarks(p);var g=i.html();e.remove();if(g=j(g)){b=a.fire("paste",{html:g});if(b!==false){b!==void 0&&(g=b);/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?f("editor/plugin/word-filter",function(b){a.insertHtml(b.toDataFormat(g,a))}):a.insertHtml(g)}}},0)}}}});var e={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};C.init=function(a){var b;a.docReady(function(){b=new s(a)});var c={copy:1,cut:1,paste:1},g=["copy","cut","paste"];a.on("contextmenu",function(i){var d=i.contextmenu;if(!d.__copyFix){d.__copyFix=
1;for(i=0;i<g.length;i++)d.addChild({content:e[g[i]],value:g[i]});d.on("click",function(b){var n=b.target.get("value");if(c[n]){d.hide();setTimeout(function(){a.execCommand("save");a.execCommand(n);setTimeout(function(){a.execCommand("save")},10)},30)}})}for(var p=d.get("children"),i=p.length-1;i>=0;i--){var f=p[i],h;h=f.get?f.get("value"):f.value;if(c[h]){h=!b._stateFromNamedCommand(h);f.set?f.set("disabled",h):f.disabled=h}}})}});
KISSY.add("editor/range","./dom,./utils,./walker,./base,./element-path,util,dom,ua,node".split(","),function(x,f,C,y){function s(a){var c=a.nodeType!==e.NodeType.TEXT_NODE&&e.nodeName(a)in b.$removeEmpty,g=a.nodeType===e.NodeType.TEXT_NODE&&!z.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return c||g||a}function r(a){return!H(a)&&!I(a)}function o(n){var b=q;return function(c){if(I(c))return t;if(c.nodeType===e.NodeType.TEXT_NODE){if(z.trim(c.nodeValue).length)return q}else if(c.nodeType===
e.NodeType.ELEMENT_NODE){c=e.nodeName(c);if(!F[c])if(!n&&!a.ie&&c==="br"&&!b)b=t;else return q}return t}}function u(a,b){var c=a.startContainer,g=a.endContainer,d=a.startOffset,i=a.endOffset,p,f=q,h=q,l,j=a.document,R;b>0&&(l=j.createDocumentFragment());if(a.collapsed)return l;a.optimizeBookmark();if(g[0].nodeType===e.NodeType.TEXT_NODE){h=t;g=g._4eSplitText(i)}else if(g[0].childNodes.length>0)if(i>=g[0].childNodes.length){g=m(g[0].appendChild(j.createTextNode("")));R=t}else g=m(g[0].childNodes[i]);
if(c[0].nodeType===e.NodeType.TEXT_NODE){f=t;c._4eSplitText(d)}else if(d)if(d>=c[0].childNodes.length){c=m(c[0].appendChild(j.createTextNode("")));p=t}else c=m(c[0].childNodes[d].previousSibling);else{p=m(j.createTextNode(""));c.prepend(p);c=p;p=t}var o=c._4eParents(),M=g._4eParents();o.each(function(a,b){o[b]=a});M.each(function(a,b){M[b]=a});for(var G,I,j=0;j<o.length;j++){G=o[j];I=M[j];if(!G.equals(I))break}for(var d=l,B,L,H=j;H<o.length;H++){B=o[H];i=b>0&&!B.equals(c)?d.appendChild(B.clone()[0]):
null;B=B[0].nextSibling;L=M[H];for(var A=g[0],r=L&&L[0];B;){if(r===B||A===B)break;L=B.nextSibling;if(b===2)d.appendChild(B.cloneNode(t));else{if(k[B.nodeName.toLowerCase()]){var w=B.cloneNode(t);B.innerHTML="";B=w}else e._4eRemove(B);b===1&&d.appendChild(B)}B=L}i&&(d=i)}for(d=l;j<M.length;j++){B=M[j];i=b>0&&!B.equals(g)?d.appendChild(B.clone()[0]):null;if(!o[j]||!B._4eSameLevel(o[j]))for(B=B[0].previousSibling;B;){L=B.previousSibling;if(b===2)d.insertBefore(B.cloneNode(t),d.firstChild);else{e._4eRemove(B);
b===1&&d.insertBefore(B,d.firstChild)}B=L}i&&(d=i)}if(b===2){if(f){G=c[0];if(G.nodeType===e.NodeType.TEXT_NODE&&G.nextSibling&&G.nextSibling.nodeType===e.NodeType.TEXT_NODE){G.data=G.data+G.nextSibling.data;G.parentNode.removeChild(G.nextSibling)}}if(h){h=g[0];if(h.nodeType===e.NodeType.TEXT_NODE&&h.previousSibling&&h.previousSibling.nodeType===e.NodeType.TEXT_NODE){h.previousSibling.data=h.previousSibling.data+h.data;h.parentNode.removeChild(h)}}}else{if(G&&I&&(!c._4eSameLevel(G)||!g._4eSameLevel(I))){h=
G._4eIndex();p&&G._4eSameLevel(c)&&h--;a.setStart(G.parent(),h+1)}a.collapse(t)}p&&c.remove();R&&g.remove();return l}function j(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function h(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=g;this.collapsed=t;this.document=a}f("./dom");var x=f("./utils"),l=f("./walker"),w=f("./base"),d=f("./element-path"),z=f("util");w.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var t=true,q=false,g=null,c=w.RangeType,p=w.PositionType,e=f("dom"),a=f("ua"),b=w.XHTML_DTD,m=f("node"),k={td:1},i={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},H=new l.whitespaces,I=new l.bookmark,A=l.whitespaces(t),J=l.bookmark(false,true),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,
i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};z.augment(h,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!==e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;
b=this.endOffset;a[0].nodeType!==e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);b&&b.nodeName()==="span"&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){if(a[0].nodeType===e.NodeType.ELEMENT_NODE&&i[a.nodeName()]){a=a.parent();b=a._4eIndex()}this.startContainer=a;this.startOffset=b;if(!this.endContainer){this.endContainer=a;this.endOffset=b}j(this)},setEnd:function(a,b){if(a[0].nodeType===e.NodeType.ELEMENT_NODE&&i[a.nodeName()]){a=a.parent();b=a._4eIndex()+1}this.endContainer=a;this.endOffset=b;if(!this.startContainer){this.startContainer=
a;this.startOffset=b}j(this)},setStartAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}j(this)},setEndAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===
e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}j(this)},cloneContents:function(){return u(this,2)},deleteContents:function(){return u(this,0)},extractContents:function(){return u(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=t},clone:function(){var a=new h(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==e.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==e.NodeType.ELEMENT_NODE)return g;var b=new l(a);b.evaluator=function(a){return A(a)&&J(a)};a=b.next();b.reset();
b=b.previous();return a&&a.equals(b)?a:g},shrink:function(a,b){if(!this.collapsed){var a=a||c.SHRINK_TEXT,g=this.clone(),m=this.startContainer,d=this.endContainer,k=this.startOffset,i=this.endOffset,p=t,h,f,j=t;if(m&&m[0].nodeType===e.NodeType.TEXT_NODE)if(k)if(k>=m[0].nodeValue.length)g.setStartAfter(m);else{g.setStartBefore(m);p=q}else g.setStartBefore(m);if(d&&d[0].nodeType===e.NodeType.TEXT_NODE)if(i)if(i>=d[0].nodeValue.length)g.setEndAfter(d);else{g.setEndAfter(d);j=q}else g.setEndBefore(d);
if(p||j){f=new l(g);f.evaluator=function(b){return b.nodeType===(a===c.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)};f.guard=function(b,g){if(a===c.SHRINK_ELEMENT&&b.nodeType===e.NodeType.TEXT_NODE||g&&b===h)return q;!g&&b.nodeType===e.NodeType.ELEMENT_NODE&&(h=b);return t}}if(p)(g=f[a===c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,b?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(j){f.reset();(f=f[a===c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(f,
b?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return p||j}},createBookmark2:function(a){var b=this.startContainer,c=this.endContainer,d=this.startOffset,k=this.endOffset,i,p;if(!b||!c)return{start:0,end:0};if(a){if(b[0].nodeType===e.NodeType.ELEMENT_NODE)if((i=m(b[0].childNodes[d]))&&i[0]&&i[0].nodeType===e.NodeType.TEXT_NODE&&d>0&&i[0].previousSibling.nodeType===e.NodeType.TEXT_NODE){b=i;d=0}for(;b[0].nodeType===e.NodeType.TEXT_NODE&&(p=b.prev(void 0,1))&&p[0].nodeType===e.NodeType.TEXT_NODE;){b=
p;d=d+p[0].nodeValue.length}if(!this.collapsed){if(c[0].nodeType===e.NodeType.ELEMENT_NODE)if((i=m(c[0].childNodes[k]))&&i[0]&&i[0].nodeType===e.NodeType.TEXT_NODE&&k>0&&i[0].previousSibling.nodeType===e.NodeType.TEXT_NODE){c=i;k=0}for(;c[0].nodeType===e.NodeType.TEXT_NODE&&(p=c.prev(void 0,1))&&p[0].nodeType===e.NodeType.TEXT_NODE;){c=p;k=k+p[0].nodeValue.length}}}return{start:b._4eAddress(a),end:this.collapsed?g:c._4eAddress(a),startOffset:d,endOffset:k,normalized:a,is2:t}},createBookmark:function(a){var b,
e,d,k,i=this.collapsed;b=m("<span>",g,this.document);b.attr("_ke_bookmark",1);b.css("display","none");b.html("&nbsp;");if(a){d=z.guid("ke_bm_");b.attr("id",d+"S")}if(!i){e=b.clone();e.html("&nbsp;");a&&e.attr("id",d+"E");k=this.clone();k.collapse();k.insertNode(e)}k=this.clone();k.collapse(t);k.insertNode(b);if(e){this.setStartAfter(b);this.setEndBefore(e)}else this.moveToPosition(b,c.POSITION_AFTER_END);return{startNode:a?d+"S":b,endNode:a?d+"E":e,serializable:a,collapsed:i}},moveToPosition:function(a,
b){this.setStartAt(a,b);this.collapse(t)},trim:function(a,b){var c=this.startContainer,g=this.startOffset,d=this.collapsed;if((!a||d)&&c[0]&&c[0].nodeType===e.NodeType.TEXT_NODE){if(g)if(g>=c[0].nodeValue.length){g=c._4eIndex()+1;c=c.parent()}else{var m=c._4eSplitText(g),g=c._4eIndex()+1,c=c.parent();if(e.equals(this.startContainer,this.endContainer))this.setEnd(m,this.endOffset-this.startOffset);else if(e.equals(c,this.endContainer))this.endOffset=this.endOffset+1}else{g=c._4eIndex();c=c.parent()}this.setStart(c,
g);if(d){this.collapse(t);return}}c=this.endContainer;g=this.endOffset;if(!b&&!d&&c[0]&&c[0].nodeType===e.NodeType.TEXT_NODE){if(g){g>=c[0].nodeValue.length||c._4eSplitText(g);g=c._4eIndex()+1}else g=c._4eIndex();c=c.parent();this.setEnd(c,g)}},insertNode:function(a){this.optimizeBookmark();this.trim(q,t);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=m(this.document);
if(a.is2){var c=b._4eGetByAddress(a.start,a.normalized),e=a.startOffset,b=a.end&&b._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(c,e);b?this.setEnd(b,a):this.collapse(t)}else{c=(e=a.serializable)?m("#"+a.startNode,b):a.startNode;a=e?m("#"+a.endNode,b):a.endNode;this.setStartBefore(c);c._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(t)}},getCommonAncestor:function(a,b){var c=this.startContainer,g=this.endContainer,c=c[0]===g[0]?a&&c[0].nodeType===e.NodeType.ELEMENT_NODE&&
this.startOffset===this.endOffset-1?m(c[0].childNodes[this.startOffset]):c:c._4eCommonAncestor(g);return b&&c[0].nodeType===e.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(b,c,g,n){var d=b[c?"startContainer":"endContainer"],k,i=c?0:1,p=0,f=c?"previousSibling":"nextSibling";k=b[c?"startOffset":"endOffset"];if(d[0].nodeType===e.NodeType.TEXT_NODE){if(c){if(k)return}else if(k<d[0].nodeValue.length)return;k=d[0][f];d=d[0].parentNode}else{k=d[0].childNodes[k+(c?-1:1)]||null;d=d[0]}for(;d;){for(;k;)if(H(k)||
I(k))k=k[f];else break;if(k){if(!p)b[c?"setStartAfter":"setEndBefore"](m(k));break}d=m(d);if(d.nodeName()==="body")break;if(p||d.equals(n)){g[i]=d;p=1}else b[c?"setStartBefore":"setEndAfter"](d);k=d[0][f];d=d[0].parentNode}}return function(b){var d;switch(b){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),k=[];a(this,1,k,b);a(this,0,k,b);if(k[0]&&k[1]){b=k[0].contains(k[1])?k[1]:k[0];this.setStartBefore(b);this.setEndAfter(b)}break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:d=
new h(this.document);k=m(this.document.body);d.setStartAt(k,c.POSITION_AFTER_START);d.setEnd(this.startContainer,this.startOffset);d=new l(d);var i,p,f=l.blockBoundary(b===c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:g),j=function(a){var b=f(a);b||(i=m(a));return b},q=function(a){var b=j(a);!b&&e.nodeName(a)==="br"&&(p=m(a));return b};d.guard=j;d=d.lastBackward();i=i||k;this.setStartAt(i,i.nodeName()!=="br"&&(!d&&this.checkStartOfBlock()||d&&i.contains(d))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);d=this.clone();
d.collapse();d.setEndAt(k,c.POSITION_BEFORE_END);d=new l(d);d.guard=b===c.ENLARGE_LIST_ITEM_CONTENTS?q:j;i=g;d=d.lastForward();i=i||k;this.setEndAt(i,!d&&this.checkEndOfBlock()||d&&i.contains(d)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);p&&this.setEndAfter(p)}}}(),checkStartOfBlock:function(){var a=this.startContainer,b=this.startOffset;if(b&&a[0].nodeType===e.NodeType.TEXT_NODE&&z.trim(a[0].nodeValue.substring(0,b)).length)return q;this.trim();a=new d(this.startContainer);b=this.clone();b.collapse(t);
b.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new l(b);a.evaluator=o(t);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,b=this.endOffset;if(a[0].nodeType===e.NodeType.TEXT_NODE&&z.trim(a[0].nodeValue.substring(b)).length)return q;this.trim();a=new d(this.endContainer);b=this.clone();b.collapse(q);b.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new l(b);a.evaluator=o(q);return a.checkForward()},checkBoundaryOfElement:function(a,b){var e=this.clone();
e[b===c.START?"setStartAt":"setEndAt"](a,b===c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);e=new l(e);e.evaluator=s;return e[b===c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,g=this.endOffset,d;if(a[0].nodeType===e.NodeType.ELEMENT_NODE){d=a[0].childNodes.length;if(d>c)a=m(a[0].childNodes[c]);else if(d===0)a=a._4ePreviousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=m(a);a=a._4eNextSourceNode()||
a}}if(b[0].nodeType===e.NodeType.ELEMENT_NODE){d=b[0].childNodes.length;if(d>g)b=m(b[0].childNodes[g])._4ePreviousSourceNode(t);else if(d===0)b=b._4ePreviousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=m(b)}}a._4ePosition(b)&p.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(b,e){var g=this.createBookmark(),d=m(this.document.createElement(e));this.collapse(b);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4eTrim();a.ie||d._4eAppendBogus();
this.insertNode(d);this.moveToBookmark(g);return d},splitBlock:function(b){var e=new d(this.startContainer),k=new d(this.endContainer),i=e.block,m=k.block,p=g;if(!e.blockLimit.equals(k.blockLimit))return g;if(b!=="br"){if(!i){i=this.fixBlock(t,b);m=(new d(this.endContainer)).block}m||(m=this.fixBlock(q,b))}b=i&&this.checkStartOfBlock();e=m&&this.checkEndOfBlock();this.deleteContents();if(i&&i[0]===m[0])if(e){p=new d(this.startContainer);this.moveToPosition(m,c.POSITION_AFTER_END);m=g}else if(b){p=
new d(this.startContainer);this.moveToPosition(i,c.POSITION_BEFORE_START);i=g}else{m=this.splitElement(i);!a.ie&&!z.inArray(i.nodeName(),["ul","ol"])&&i._4eAppendBogus()}return{previousBlock:i,nextBlock:m,wasStartOfBlock:b,wasEndOfBlock:e,elementPath:p}},splitElement:function(a){if(!this.collapsed)return g;this.setEndAt(a,c.POSITION_BEFORE_END);var b=this.extractContents(),e=a.clone(q);e[0].appendChild(b);e.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return e},moveToElementEditablePosition:function(a,
b){for(var g=0;a;){if(a[0].nodeType===e.NodeType.TEXT_NODE){this.moveToPosition(a,b?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);g=1;break}if(a[0].nodeType===e.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);g=1}var d=a,k=g,i=void 0;d[0].nodeType===e.NodeType.ELEMENT_NODE&&d._4eIsEditable()&&(i=d[b?"last":"first"](r,1));!k&&!i&&(i=d[b?"prev":"next"](r,1));a=i}return!!g},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,
b.nodeType===e.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var c,e,g,d=a.nodeName();c=b.$block[d];this.deleteContents();if(c){for(c=this.getCommonAncestor(q,t);(e=b[c.nodeName()])&&(!e||!e[d]);){var k=c.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(c);this.collapse(t);c.remove()}else g=c;c=k}g&&this.splitElement(g)}this.insertNode(a)}});x.injectDom({_4eBreakParent:function(a,b){var b=m(b),a=m(a),c,e=new w.Range(a[0].ownerDocument);
e.setStartAfter(a);e.setEndAfter(b);c=e.extractContents();e.insertNode(a.remove());a.after(c)}});w.Range=h;y.exports=h});
KISSY.add("editor/dom","util,node,./base,./utils,dom,ua".split(","),function(x,f){function C(g,c){var d=g[c?"next":"prev"](void 0,1);if(d&&d[0].nodeType===h.ELEMENT_NODE){for(var e=[];d.attr("_ke_bookmark")||d._4eIsEmptyInlineRemovable(void 0);){e.push(d);d=c?d.next(void 0,1):d.prev(void 0,1);if(!d)return}if(g._4eIsIdentical(d,void 0)){for(var a=s(c?g[0].lastChild:g[0].firstChild);e.length;)e.shift()._4eMove(g,!c,void 0);d._4eMoveChildren(g,!c,void 0);d.remove();a[0]&&a[0].nodeType===h.ELEMENT_NODE&&
a._4eMergeSiblings()}}}var y=f("util"),s=f("node"),r=f("./base"),o=f("./utils"),u=r.XHTML_DTD,j=f("dom"),h=j.NodeType,l=f("ua"),w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var d=r.PositionType,z={block:1,"list-item":1,
table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},t={hr:1},q=function(g){return g&&(g[0]||g)};o.injectDom({_4eSameLevel:function(g,c){var c=q(c),d=g.parentNode;return d&&d===c.parentNode},_4eIsBlockBoundary:function(g,c){var d=y.merge(t,c);return!(!z[j.css(g,"display")]&&!d[j.nodeName(g)])},_4eIndex:function(g,c){for(var d=g.parentNode.childNodes,e,a=-1,b=0;b<d.length;b++){e=d[b];if(!c||
!(e.nodeType===3&&e.previousSibling&&e.previousSibling.nodeType===3)){a++;if(e===g)return a}}return-1},_4eMove:function(g,c,d){c=q(c);d?c.insertBefore(g,c.firstChild):c.appendChild(g)},_4eIsIdentical:function(g,c){if(!c)return false;c=q(c);if(j.nodeName(g)!==j.nodeName(c))return false;var d=g.attributes,e,a,b=c.attributes,m=d.length,k=b.length;if(m!==k)return false;for(var i=0;i<m;i++){e=d[i];a=e.name;if(e.specified&&j.attr(g,a)!==j.attr(c,a))return false}if(l.ieMode<8)for(i=0;i<k;i++){e=b[i];a=e.name;
if(e.specified&&j.attr(g,a)!==j.attr(c,a))return false}return true},_4eIsEmptyInlineRemovable:function(g){if(!u.$removeEmpty[j.nodeName(g)])return false;for(var g=g.childNodes,c=0,d=g.length;c<d;c++){var e=g[c],a=e.nodeType;if(!(a===h.ELEMENT_NODE&&e.getAttribute("_ke_bookmark"))&&(a===h.ELEMENT_NODE&&!j._4eIsEmptyInlineRemovable(e)||a===j.NodeType.TEXT_NODE&&y.trim(e.nodeValue)))return false}return true},_4eMoveChildren:function(g,c,d){c=q(c);if(g!==c)if(d)for(;d=g.lastChild;)c.insertBefore(g.removeChild(d),
c.firstChild);else for(;d=g.firstChild;)c.appendChild(g.removeChild(d))},_4eMergeSiblings:function(g){g=s(g);if(w[g.nodeName()]){C(g,true);C(g)}},_4eSplitText:function(g,c){var d=g.ownerDocument;if(g.nodeType===j.NodeType.TEXT_NODE){if(l.ie&&c===g.nodeValue.length){var e=d.createTextNode("");j.insertAfter(e,g);return e}e=g.splitText(c);if(d.documentMode){d=d.createTextNode("");j.insertAfter(d,e);j.remove(d)}return e}},_4eParents:function(d,c){var f=[];f.__IS_NODELIST=1;do f[c?"push":"unshift"](d);
while(d=d.parentNode);return f},_4eNextSourceNode:function(d,c,f,e){if(e&&!e.call)var a=q(e),e=function(b){return b!==a};var c=!c&&d.firstChild,b=d;if(!c){if(d.nodeType===h.ELEMENT_NODE&&e&&e(d,true)===false)return null;c=d.nextSibling}for(;!c&&(b=b.parentNode);){if(e&&e(b,true)===false)return null;c=b.nextSibling}return!c||e&&e(c)===false?null:f&&f!==c.nodeType?j._4eNextSourceNode(c,false,f,e):c},_4ePreviousSourceNode:function(d,c,f,e){if(e&&!e.call)var a=q(e),e=function(b){return b!==a};var c=!c&&
d.lastChild,b=d;if(!c){if(d.nodeType===h.ELEMENT_NODE&&e&&e(d,true)===false)return null;c=d.previousSibling}for(;!c&&(b=b.parentNode);){if(e&&e(b,true)===false)return null;c=b.previousSibling}return!c||e&&e(c)===false?null:f&&c.nodeType!==f?j._4ePreviousSourceNode(c,false,f,e):c},_4eCommonAncestor:function(d,c){c=q(c);if(d===c)return d;if(j.contains(c,d))return c;var f=d;do if(j.contains(f,c))return f;while(f=f.parentNode);return null},_4eHasAttributes:l.ieMode<9?function(d){for(var c=d.attributes,
f=0;f<c.length;f++){var e=c[f];switch(e.name){case "class":if(d.getAttribute("class"))return true;break;default:if(e.specified)return true}}return false}:function(d){l.gecko&&d.removeAttribute("_moz_dirty");return d.hasAttributes()},_4ePosition:function(g,c){var f=q(c);if(g.compareDocumentPosition)return g.compareDocumentPosition(f);if(g===f)return d.POSITION_IDENTICAL;if(g.nodeType===h.ELEMENT_NODE&&f.nodeType===h.ELEMENT_NODE){if(j.contains(g,f))return d.POSITION_CONTAINS+d.POSITION_PRECEDING;if(j.contains(f,
g))return d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING;if("sourceIndex"in g)return g.sourceIndex<0||f.sourceIndex<0?d.POSITION_DISCONNECTED:g.sourceIndex<f.sourceIndex?d.POSITION_PRECEDING:d.POSITION_FOLLOWING}for(var e=j._4eAddress(g),f=j._4eAddress(f),a=Math.min(e.length,f.length),b=0;b<=a-1;b++)if(e[b]!==f[b])return e[b]<f[b]?d.POSITION_PRECEDING:d.POSITION_FOLLOWING;return e.length<f.length?d.POSITION_CONTAINS+d.POSITION_PRECEDING:d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING},_4eAddress:function(d,
c){for(var f=[],e=d.ownerDocument.documentElement,a=d;a&&a!==e;){f.unshift(j._4eIndex(a,c));a=a.parentNode}return f},_4eRemove:function(d,c){var f=d.parentNode;if(f){if(c)for(var e;e=d.firstChild;)f.insertBefore(d.removeChild(e),d);f.removeChild(d)}return d},_4eTrim:function(d){j._4eLtrim(d);j._4eRtrim(d)},_4eLtrim:function(d){for(var c;c=d.firstChild;){if(c.nodeType===j.NodeType.TEXT_NODE){var f=o.ltrim(c.nodeValue),e=c.nodeValue.length;if(f){if(f.length<e){j._4eSplitText(c,e-f.length);d.removeChild(d.firstChild)}}else{d.removeChild(c);
continue}}break}},_4eRtrim:function(d){for(var c;c=d.lastChild;){if(c.type===j.NodeType.TEXT_NODE){var f=o.rtrim(c.nodeValue),e=c.nodeValue.length;if(f){if(f.length<e){j._4eSplitText(c,f.length);d.removeChild(d.lastChild)}}else{d.removeChild(c);continue}}break}if(!l.ie)(c=d.lastChild)&&c.nodeType===1&&j.nodeName(c)==="br"&&d.removeChild(c)},_4eAppendBogus:function(d){for(var c=d.lastChild;c&&c.nodeType===j.NodeType.TEXT_NODE&&!y.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType===j.NodeType.TEXT_NODE||
j.nodeName(c)!=="br"){c=d.ownerDocument.createElement("br");d.appendChild(c)}},_4eSetMarker:function(d,c,f,e){var d=s(d),a=d.data("list_marker_id")||d.data("list_marker_id",y.guid()).data("list_marker_id"),b=d.data("list_marker_names")||d.data("list_marker_names",{}).data("list_marker_names");c[a]=d;b[f]=1;return d.data(f,e)},_4eClearMarkers:function(d,c,f){var d=s(d),e=d.data("list_marker_names"),a=d.data("list_marker_id"),b;for(b in e)d.removeData(b);d.removeData("list_marker_names");if(f){d.removeData("list_marker_id");
delete c[a]}},_4eCopyAttributes:function(d,c,f){for(var c=s(c),e=d.attributes,f=f||{},a=0;a<e.length;a++){var b=e[a],m=b.name.toLowerCase(),k;if(!(m in f))if(m==="checked"&&(k=j.attr(d,m)))c.attr(m,k);else if(b.specified||l.ie&&b.value&&m==="value"){k=j.attr(d,m);if(k===null)k=b.nodeValue;c.attr(m,k)}}if(d.style.cssText!=="")c[0].style.cssText=d.style.cssText},_4eIsEditable:function(d){d=j.nodeName(d);return(d=!u.$nonEditable[d]&&(u[d]||u.span))&&d["#text"]},_4eGetByAddress:function(d,c,f){for(var d=
d.documentElement,e=0;d&&e<c.length;e++){var a=c[e];if(f)for(var b=-1,m=0;m<d.childNodes.length;m++){var k=d.childNodes[m];if(!(f===true&&k.nodeType===3&&k.previousSibling&&k.previousSibling.nodeType===3)){b++;if(b===a){d=k;break}}}else d=d.childNodes[a]}return d}})});
KISSY.add("editor/walker",["./base","util","ua","dom","node"],function(x,f,C,y){function s(c,a){if(this._.end)return l;var b,f=this.range,k,i=this.guard,g=this.type,q=c?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),l;if(!c&&!this._.guardLTR){var p=f.endContainer[0],o=p.childNodes[f.endOffset];this._.guardLTR=function(a,b){return b&&(p===a||"body"===d.nodeName(a))?!1:a!==o}}if(c&&!this._.guardRTL){var r=f.startContainer[0],n=0<
f.startOffset&&r.childNodes[f.startOffset-1]||null;this._.guardRTL=function(a,b){return b&&(r===a||"body"===d.nodeName(a))?!1:a!==n}}var w=c?this._.guardRTL:this._.guardLTR;k=i?function(a,b){return w(a,b)===h?h:i(a,b)}:w;this.current?b=this.current[q](h,g,k):c?(b=f.endContainer,0<f.endOffset?(b=t(b[0].childNodes[f.endOffset-1]),k(b[0])===h&&(b=l)):b=k(b,j)===h?l:b._4ePreviousSourceNode(j,g,k,void 0)):(b=f.startContainer,b=t(b[0].childNodes[f.startOffset]),b.length?k(b[0])===h&&(b=l):b=k(f.startContainer,
j)===h?l:f.startContainer._4eNextSourceNode(j,g,k,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==h){if(!a)return b}else if(a&&this.evaluator)return h;b=b[q](h,g,k)}this.end();return this.current=l}function r(c){for(var a,b=l;a=s.call(this,c);)b=a;return b}function o(c){this.range=c;this.guard=this.evaluator=l;this._={}}var x=f("./base"),u=f("util"),j=!0,h=!1,l=null,w=f("ua"),d=f("dom"),z=x.XHTML_DTD,t=f("node");u.augment(o,{end:function(){this._.end=1},next:function(){return s.call(this)},
previous:function(){return s.call(this,j)},checkForward:function(){return s.call(this,h,j)!==h},checkBackward:function(){return s.call(this,j,j)!==h},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,j)},reset:function(){delete this.current;this._={}},_iterator:s});u.mix(o,{blockBoundary:function(c){return function(a){return!(a.nodeType===d.NodeType.ELEMENT_NODE&&d._4eIsBlockBoundary(a,c))}},bookmark:function(c,a){function b(a){return"span"===d.nodeName(a)&&d.attr(a,
"_ke_bookmark")}return function(f){var k,i;k=f.nodeType===d.NodeType.TEXT_NODE&&(i=f.parentNode)&&b(i);k=c?k:k||b(f);return!!(a^k)}},whitespaces:function(c){return function(a){a=a.nodeType===d.NodeType.TEXT_NODE&&!u.trim(a.nodeValue);return!!(c^a)}},invisible:function(c){var a=o.whitespaces();return function(b){b=a(b)||b.nodeType===d.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(c^b)}}});var q=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,g=o.whitespaces(),c=o.bookmark(),p=function(e){var a=d.nodeName(e);return c(e)||
g(e)||1===e.nodeType&&a in z.$inline&&!(a in z.$empty)};x.Utils.injectDom({_4eGetBogus:function(c){c=t(c);do c=c._4ePreviousSourceNode();while(c&&p(c[0]));return c&&(!w.ie?"br"===c.nodeName():3===c[0].nodeType&&q.test(c.text()))?c[0]:!1}});x.Walker=o;y.exports=o});
KISSY.add("editor/element-path",["./base","./dom","dom"],function(x,f,C,y){function s(f){for(var w=u,d=u,s=[];f;){if(f[0].nodeType===r.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=f);var t=f.nodeName();if(!d&&(!w&&j[t]&&(w=f),h[t])){var q;if(q=!w)if(q="div"===t){a:{q=f[0].childNodes;for(var g=0,c=q.length;g<c;g++){var p=q[g];if(p.nodeType===r.NodeType.ELEMENT_NODE&&o.$block[p.nodeName.toLowerCase()]){q=!0;break a}}q=!1}q=!q}q?w=f:d=f}s.push(f);if("body"===t)break}f=f.parent()}this.block=
w;this.blockLimit=d;this.elements=s}x=f("./base");f("./dom");var r=f("dom"),o=x.XHTML_DTD,u=null,j={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},h={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};s.prototype={constructor:s,compare:function(f){var h=this.elements,f=f&&f.elements;if(!f||h.length!==f.length)return!1;for(var d=0;d<h.length;d++)if(!r.equals(h[d],f[d]))return!1;return!0},contains:function(f){for(var h=this.elements,d=0;d<h.length;d++)if(h[d].nodeName()in
f)return h[d];return u},toString:function(){var f=this.elements,h,d=[];for(h=0;h<f.length;h++)d.push(f[h].nodeName());return d.toString()}};x.ElementPath=s;y.exports=s});
KISSY.add("editor/selection","util,node,./walker,./range,./base,ua,dom".split(","),function(x,f,C,y){function s(a){this.document=a;this._={cache:{}};if(q)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!==a||b.parentElement&&b.parentElement().ownerDocument!==a)this.isInvalid=h}catch(c){this.isInvalid=h}}function r(a){a=new s(a);return!a||a.isInvalid?l:a}var x=f("util"),o=f("node"),C=f("./walker"),u=f("./range"),j=f("./base");j.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,
SELECTION_ELEMENT:3};var h=true,l=null,w=f("ua"),d=f("dom"),z=j.SelectionType,t=j.RangeType,q=document.selection,g={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(s,{getNative:!q?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=d.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!q?function(){var a=
this._.cache;if(a.type)return a.type;var b=z.SELECTION_TEXT,c=this.getNative();if(c){if(c.rangeCount===1){var c=c.getRangeAt(0),e=c.startContainer;if(e===c.endContainer&&e.nodeType===d.NodeType.ELEMENT_NODE&&Number(c.endOffset-c.startOffset)===1&&g[e.childNodes[c.startOffset].nodeName.toLowerCase()])b=z.SELECTION_ELEMENT}}else b=z.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=z.SELECTION_NONE;try{var c=this.getNative(),d=c.type;if(d==="Text")b=z.SELECTION_TEXT;
if(d==="Control")b=z.SELECTION_ELEMENT;if(c.createRange().parentElement)b=z.SELECTION_TEXT}catch(e){}return a.type=b},getRanges:q?function(){var a=function(a,c){a=a.duplicate();a.collapse(c);for(var e=a.parentElement(),f=e.childNodes,g,h=0;h<f.length;h++){var j=f[h];if(j.nodeType===d.NodeType.ELEMENT_NODE){g=a.duplicate();g.moveToElementText(j);var j=g.compareEndPoints("StartToStart",a),q=g.compareEndPoints("EndToStart",a);g.collapse();if(j>0)break;else{if(!j||q===1&&j===-1)return{container:e,offset:h};
if(!q)return{container:e,offset:h+1}}g=l}}if(!g){g=a.duplicate();g.moveToElementText(e);g.collapse(false)}g.setEndPoint("StartToStart",a);g=(""+g.text).replace(/\r\n|\r/g,"\n").length;try{for(;g>0;)g=g-f[--h].nodeValue.length}catch(p){g=0}return g===0?{container:e,offset:h}:{container:f[h],offset:-g}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var d=this.getNative(),b=d&&d.createRange(),e=this.getType();if(!d)return[];if(e===z.SELECTION_TEXT){d=new u(this.document);e=a(b,
h);d.setStart(o(e.container),e.offset);e=a(b);d.setEnd(o(e.container),e.offset);c.ranges=[d];return[d]}if(e===z.SELECTION_ELEMENT){c=c.ranges=[];for(e=0;e<b.length;e++){for(var f=b.item(e),g=f.parentNode,j=0,d=new u(this.document);j<g.childNodes.length&&g.childNodes[j]!==f;j++);d.setStart(o(g),j);d.setEnd(o(g),j+1);c.push(d)}return c}c.ranges=[];return[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var e=
c.getRangeAt(d),f=new u(this.document);f.setStart(o(e.startContainer),e.startOffset);f.setEnd(o(e.endContainer),e.endOffset);a.push(f)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(a.startElement!==void 0)return a.startElement;var b,c=this.getNative();switch(this.getType()){case z.SELECTION_ELEMENT:return this.getSelectedElement();case z.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();h;){b=e.startContainer;if(e.startOffset===(b[0].nodeType===d.NodeType.ELEMENT_NODE?
b[0].childNodes.length:b[0].nodeValue.length)&&!b._4eIsBlockBoundary())e.setStartAfter(b);else break}b=e.startContainer;if(b[0].nodeType!==d.NodeType.ELEMENT_NODE)return b.parent();b=o(b[0].childNodes[e.startOffset]);if(!b[0]||b[0].nodeType!==d.NodeType.ELEMENT_NODE)return e.startContainer;for(e=b[0].firstChild;e&&e.nodeType===d.NodeType.ELEMENT_NODE;){b=o(e);e=e.firstChild}return b}if(q){e=c.createRange();e.collapse(h);b=o(e.parentElement())}else{if((b=c.anchorNode)&&b.nodeType!==d.NodeType.ELEMENT_NODE)b=
b.parentNode;b&&(b=o(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;if(b.selectedElement!==void 0)return b.selectedElement;if(q){a=this.getNative().createRange();a=a.item&&a.item(0)}var c;if(a)c=o(a);else{a=this.getRanges()[0];for(var e,f=2;f&&(!(c=a.getEnclosedNode())||!(c[0].nodeType===d.NodeType.ELEMENT_NODE&&g[c.nodeName()]&&(e=c)));f--)a.shrink(t.SHRINK_ELEMENT);c=e}a=c;return b.selectedElement=a},reset:function(){this._.cache={}},selectElement:function(a){var b,
c=this.document;if(q)try{b=c.body.createControlRange();b.addElement(a[0]);b.select()}catch(d){b=c.body.createTextRange();b.moveToElementText(a[0]);b.select()}finally{}else{b=c.createRange();b.selectNode(a[0]);a=this.getNative();a.removeAllRanges();a.addRange(b)}this.reset()},selectRanges:function(a){if(q){if(a.length>1){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var e=
a[c],f=this.document.createRange(),g=e.startContainer;if(e.collapsed&&(w.gecko&&w.gecko<1.09||w.webkit)&&g[0].nodeType===d.NodeType.ELEMENT_NODE&&!g[0].childNodes.length){g[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":""));e.startOffset++;e.endOffset++}f.setStart(g[0],e.startOffset);f.setEnd(e.endContainer[0],e.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,
b){for(var c=[],e=this.document,f,b=b||this.getRanges(),g=b.length,j=0;j<g;j++){c.push(f=b[j].createBookmark(a,h));var q=(a=f.serializable)?o("#"+f.startNode,e):f.startNode;f=a?o("#"+f.endNode,e):f.endNode;for(var l=j+1;l<g;l++){var p=b[l],n=p.startContainer,t=p.endContainer;d.equals(n,q.parent())&&p.startOffset++;d.equals(n,f.parent())&&p.startOffset++;d.equals(t,q.parent())&&p.endOffset++;d.equals(t,f.parent())&&p.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var d=
new u(this.document);d.moveToBookmark(a[c]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4eCommonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true})},removeAllRanges:function(){var a=this.getNative();q?a&&a.clear():a&&a.removeAllRanges()}});var c={table:1,tbody:1,tr:1},p=C.whitespaces(h),
e=/\ufeff|\u00a0/;u.prototype.select=!q?function(){var a=this.startContainer;if(this.collapsed&&a[0].nodeType===d.NodeType.ELEMENT_NODE&&!a[0].childNodes.length){a[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":""));this.startOffset++;this.endOffset++}var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(h);b.setEnd(this.endContainer[0],this.endOffset)}else throw c;
}a=r(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,f,g;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset===1){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType===d.NodeType.ELEMENT_NODE){(new s(this.document)).selectElement(o(i));return}}(this.startContainer[0].nodeType===d.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType===d.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in
c)&&this.shrink(t.SHRINK_ELEMENT,h);var j=this.createBookmark(),i=j.startNode,q;if(!b)q=j.endNode;j=this.document.body.createTextRange();j.moveToElementText(i[0]);j.moveStart("character",1);if(q){a=this.document.body.createTextRange();a.moveToElementText(q[0]);j.setEndPoint("EndToEnd",a);j.moveEnd("character",-1)}else{for(f=i[0].nextSibling;f&&!p(f);)f=f.nextSibling;f=!(f&&f.nodeValue&&f.nodeValue.match(e))&&(a||!i[0].previousSibling||i[0].previousSibling&&d.nodeName(i[0].previousSibling)==="br");
g=o(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(i);f&&d.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4eRemove();if(b){if(f){j.moveStart("character",-1);j.select();this.document.selection.clear()}else j.select();if(g){this.moveToPosition(g,t.POSITION_BEFORE_START);g._4eRemove()}}else{this.setEndBefore(q);q._4eRemove();j.select()}};s.getSelection=r;j.Selection=s;y.exports=s});
KISSY.add("editor/enter-key","util,node,ua,./walker,./base,./element-path".split(","),function(x,f,C){function y(f){var q;q=f.getSelection().getRanges();for(var g=q.length-1;g>0;g--)q[g].deleteContents();q=q[0];var g=q.document,c=new l(q.startContainer),p=q.checkStartOfBlock(),e=q.checkEndOfBlock(),c=c.block;if(p&&e){if(c&&(c.nodeName()==="li"||c.parent().nodeName()==="li")){if(f.hasCommand("outdent")){f.execCommand("save");f.execCommand("outdent");f.execCommand("save");return true}return false}}else if(c&&
c.nodeName()==="pre"&&!e){var a=u.ieMode<9?o(g.createTextNode("\r")):o(g.createElement("br"));q.insertNode(a);if(u.ieMode<9){a=o(g.createTextNode("\ufeff")).insertAfter(a);q.setStartAt(a,h.RangeType.POSITION_AFTER_START)}else q.setStartAfter(a);q.collapse(true);q.select();if(u.ieMode<9)a[0].nodeValue="";return}var b=q.splitBlock("p");if(!b)return true;var f=b.previousBlock,c=b.nextBlock,p=b.wasStartOfBlock,e=b.wasEndOfBlock,m;if(c){m=c.parent();if(m.nodeName()==="li"){c._4eBreakParent(m);c._4eMove(c.next(),
true)}}else if(f&&(m=f.parent())&&m.nodeName()==="li"){f._4eBreakParent(m);q.moveToElementEditablePosition(f.next());f._4eMove(f.prev())}if(!p&&!e){if(c.nodeName()==="li"&&(m=c.first(j.invisible(true)))&&r.inArray(m.nodeName(),["ul","ol"]))(w?o(g.createTextNode("\u00a0")):o(g.createElement("br"))).insertBefore(m);c&&q.moveToElementEditablePosition(c)}else{if(f){if(f.nodeName()==="li"||!d.test(f.nodeName()))a=f.clone()}else c&&(a=c.clone());a||(a=o("<p>",null,g));if(m=b.elementPath)for(var b=0,k=m.elements.length;b<
k;b++){var i=m.elements[b];if(i.equals(m.block)||i.equals(m.blockLimit))break;if(z.$removeEmpty[i.nodeName()]){i=i.clone();a._4eMoveChildren(i);a.append(i)}}w||a._4eAppendBogus();q.insertNode(a);if(w&&p&&(!e||!f[0].childNodes.length)){q.moveToElementEditablePosition(e?f:a);q.select()}q.moveToElementEditablePosition(p&&!e?c:a)}if(!w)if(c){a=o(g.createElement("span"));a.html("&nbsp;");q.insertNode(a);a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});q.deleteContents()}else a.scrollIntoView(void 0,
{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});q.select();return true}function s(d){d.get("document").on("keydown",function(f){if(f.keyCode===13&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){d.execCommand("save");var g=d.execCommand("enterBlock");d.execCommand("save");g!==false&&f.preventDefault()}})}var r=f("util"),o=f("node"),u=f("ua"),j=f("./walker"),h=f("./base"),l=f("./element-path"),w=u.ieMode<11,d=/^(?:h[1-6])|(?:pre)$/i,z=h.XHTML_DTD;C.init=function(d){d.addCommand("enterBlock",
{exec:y});d.docReady(function(){s(d)})}});
KISSY.add("editor/html-data-processor",["html-parser","ua","node","util"],function(x,f,C){function y(f){if(!j.$removeEmpty[f.nodeName])return!1;var f=f.childNodes,d,l,o=f.length;if(o)for(d=0;d<o;d++)if(l=f[d],l.nodeType!==h.TEXT_NODE||l.nodeValue||!y(l))return!1;return!0}var s=f("html-parser"),r=f("ua"),o=11>r.ieMode,u=f("node"),j=s.DTD,h=u.Dom.NodeType,l=f("util");C.init=function(f){function d(a){return!y(a)}function h(a){return a.replace(p,function(a,b,c){return"<"+b+c.replace(e,function(a,b){return-1===
c.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function t(a){return a.replace(b,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function q(a){return a.replace(m,function(a,b){return l.urlDecode(b)})}var g=new s.Filter,c=new s.Filter;(function(){function b(c){c=s.serialize(c);return new s.Comment(a+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var e={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,
noscript:b,span:d}},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=["name","href","src"],c,d=0;d<b.length;d++)c="_keSaved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:d,strong:d,
em:d,del:d,u:d},attributes:{style:function(a){if(!l.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,a.length)===a)return b=l.trim(l.urlDecode(b.substr(a.length))),s.parse(b).childNodes[0]}};o&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});g.addRules(f);c.addRules(e)})();(function(){function a(b){for(var b=b.childNodes,c=b.length,d=b[c-1];d&&(3===
d.nodeType&&!l.trim(d.nodeValue)||1===d.nodeType&&y(d));)d=b[--c];return d}function b(c){var d=a(c);d&&(1===d.nodeType&&"br"===d.nodeName?c.removeChild(d):3===d.nodeType&&h.test(d.nodeValue)&&c.removeChild(d))}function d(b){var c=a(b);return!c||"form"===b.nodeName&&"input"===c.nodeName}function e(a){b(a);d(a)&&(o||a.appendChild(new s.Tag("br")))}function f(a){b(a);d(a)&&a.appendChild(new s.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,i=l.merge(j.$block,j.$listItem,j.$tableContent),k;for(k in i)"br"in
j[k]||delete i[k];delete i.pre;var m={tags:{}},q={tags:{}};for(k in i)m.tags[k]=e,q.tags[k]=f;c.addRules(m);g.addRules(q)})();g.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var p=/<(a|area|img|input)\b([^>]*)>/gi,e=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}",b=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,m=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
k=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,i=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,x=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;f.htmlDataProcessor={dataFilter:c,htmlFilter:g,toHtml:function(a){r.webkit&&(a=a.replace(/\u200b/g,""));var b=new s.BeautifyWriter;(new s.Parser(a)).parse().writeHtml(b,g);return a=b.getHtml()},toDataFormat:function(a,b){var b=b||c,a=t(a),a=h(a),a=a.replace(k,"$1ke:$2"),a=a.replace(x,"<ke:$1$2></ke:$1>"),
d=u("<div>");d.html("a"+a);a=d.html().substr(1);a=a.replace(i,"$1$2");a=q(a);d=new s.BasicWriter;(new s.Parser(a)).parse().writeHtml(d,b);return a=d.getHtml()},toServer:function(a){var b=new s.MinifyWriter;(new s.Parser(a)).parse().writeHtml(b,g);return b.getHtml()}}}});
KISSY.add("editor/selection-fix",["./base","./selection","node","ua","dom"],function(x,f,C){function y(d){function f(a,b){var c=j.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=w}return c}function c(){var a=j.selection.createRange();k&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&k.select();b.detach("mouseup",c);b.detach("mousemove",h);k=e=0}function h(a){if(a.button){if(a=f(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",k)?a.setEndPoint("StartToStart",k):a.setEndPoint("EndToEnd",
k),a.select()}else c()}var e,a=d.get("window")[0],b=d.get("document"),j=b[0],k;b.on("mousedown contextmenu",function(d){var l=j.documentElement;if(d.target===l&&(e&&c(),!(l.scrollHeight>l.clientHeight)&&(e=1,k=f(d.pageX,d.pageY))))b.on("mouseup",c),b.on("mousemove",h),a.focus(),k.select()})}function s(f){function g(d){if(b){var e=f.getSelection(),j=e&&e.getType(),l=e&&c.selection;if(d&&l&&j===t.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){g(h)},50);else{var m;if(!l||
!l.type||!("Control"!==l.type&&(m=l.createRange())&&(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))a=l&&e.getRanges()[0],f.checkSelectionChange()}}}var c=f.get("document")[0],p=j(c.body),e=j(c.documentElement);if(8>d.ieMode)e.on("click",function(a){"html"===j(a.target).nodeName()&&f.getSelection().getNative().createRange().select()});var a,b,m=h;e.on("mousedown",function(){m=l});e.on("mouseup",function(){m=h});p.on("focusin",function(b){if("body"===j(b.target).nodeName()&&
a){try{m&&a.select()}catch(c){}a=w}});p.on("focus",function(){b=h;g()});p.on("beforedeactivate",function(a){a.relatedTarget||(b=l,m=h)});p.on("mousedown",function(){b=l});p.on("mouseup",function(){b=h;setTimeout(function(){g(h)},0)});p.on("keydown",function(){b=l});p.on("keyup",function(){b=h;setTimeout(function(){g()},0)})}function r(d){d.get("document").on("mouseup keyup selectionchange",function(){d.checkSelectionChange()})}function o(f){function g(a){var b=u.XHTML_DTD;return a._4eIsBlockBoundary()&&
b.$empty[a.nodeName()]}function c(b){return e(b)&&a(b)}var p=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,e=u.Walker.whitespaces(h),a=u.Walker.bookmark(l,h),b=function(a){return e(a)&&8!==a.nodeType};f.on("selectionChange",function(a){var e=a.path,i=f.get("document")[0],o=j(i.body),a=(a=a.selection)&&a.getRanges()[0],r=e.blockLimit;o[0]||(i.documentElement.appendChild(i.createElement("body")),o=j(i.body),a&&(a.setStart(o,
0),a.collapse(1)));r=r||o;if(d.gecko){var s=(i=e.block||e.blockLimit)&&i.last(c);i&&i._4eIsBlockBoundary()&&(!s||!(1===s[0].nodeType&&s._4eIsBlockBoundary()))&&"pre"!==i.nodeName()&&!i._4eGetBogus()&&i._4eAppendBogus()}if(a&&a.collapsed&&!e.block){if("body"===r.nodeName()){"html"===a.startContainer.nodeName()&&a.setStart(o,0);if((e=a.fixBlock(h,"p"))&&e[0]!==o[0].lastChild&&e.outerHtml().match(p))if((i=e.next(b,1))&&i[0].nodeType===z.NodeType.ELEMENT_NODE&&!g[i])a.moveToElementEditablePosition(i),
e._4eRemove();else if((i=e.prev(b,1))&&i[0].nodeType===z.NodeType.ELEMENT_NODE&&!g[i])a.moveToElementEditablePosition(i,i.outerHtml().match(p)?l:h),e._4eRemove();a.select();f.notifySelectionChange()}e=f.get("document")[0];a=new u.Range(e);a.moveToElementEditablePosition(o,h);"body"!==(new u.ElementPath(a.startContainer)).blockLimit.nodeName()&&(o=j(e.createElement("p")).appendTo(o),d.ie||o._4eAppendBogus())}})}var u=f("./base");f("./selection");var j=f("node"),h=!0,l=!1,w=null,d=f("ua"),z=f("dom"),
t=u.SelectionType;C.init=function(f){f.docReady(function(){if(document.selection)y(f),s(f);else if(r(f),d.ie){var g,c=f.get("document");c.on("focusout",function(){g=f.getSelection().getRanges()});c.on("focusin",function(){g&&(f.getSelection().selectRanges(g),g=null)})}});o(f)}});
KISSY.add("editor/styles","util,./selection,./range,./base,./element-path,node,dom,ua".split(","),function(x,f,C,y){function s(a){return!D.attr(a,"_ke_bookmark")}function r(a,b){for(var c in a)typeof a[c]==="string"?a[c]=a[c].replace(T,function(a,c){return b[c]}):r(a[c],b)}function o(a,b){if(b){a=k.clone(a);r(a,b)}var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type=c==="#text"||P[c]?K.STYLE_BLOCK:S[c]?K.STYLE_OBJECT:K.STYLE_INLINE;this._={definition:a}}function u(a,
b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=new i(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function j(a,b,c){var d=a.element;d==="*"&&(d="span");b=n(b.createElement(d));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=o.getStyleText(c);if(a)for(var e in a)b.attr(e,a[e]);if(c)b[0].style.cssText=c;return b}function h(a){var b=a.createBookmark(A),c=a.createIterator();c.enforceRealBlocks=A;c.enlargeBr=A;for(var e,f=a.document;e=
c.getNextParagraph();){var g=j(this,f,e),h=g,g=h.nodeName==="pre",i=e.nodeName==="pre",k=!g&&i;if(g&&!i){i=e;k=i.html();k=l(k,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,"");k=k.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1");k=k.replace(/([\t\n\r]+|&nbsp;)/g," ");k=k.replace(/<br\b[^>]*>/gi,"\n");if(O.ie){i=i[0].ownerDocument.createElement("div");i.appendChild(h[0]);h.outerHtml("<pre>"+k+"</pre>");h=n(i.firstChild);h._4eRemove()}else h.html(k)}else k?h=d(w(e),h):e._4eMoveChildren(h);e[0].parentNode.replaceChild(h[0],
e[0]);if(g){e=h;g=void 0;if((g=e._4ePreviousSourceNode(A,D.NodeType.ELEMENT_NODE))&&g.nodeName()==="pre"){h=l(g.html(),/\n$/,"")+"\n\n"+l(e.html(),/^\n/,"");O.ie?e.outerHtml("<pre>"+h+"</pre>"):e.html(h);g._4eRemove()}}}a.moveToBookmark(b)}function l(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function w(a){var b=[];l(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(a,b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function d(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=l(e,/^[\t]*\n/,""),e=l(e,/\n$/,""),e=l(e,/^[\t]+|[\t]+$/g,function(a,b){return a.length===1?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(e);c.appendChild(f[0])}return c}function z(b){var c=b.document;if(b.collapsed){c=j(this,c,void 0);b.insertNode(c);b.moveToPosition(c,v.POSITION_BEFORE_END)}else{var d=this.element,e=this._.definition,f,g=N[d];if(!g){f=A;g=N.span}var h=b.createBookmark();b.enlarge(v.ENLARGE_ELEMENT);b.trim();for(var i=b.createBookmark(),k=i.startNode,i=i.endNode,l=k,o;l&&l[0];){var m=J;if(D.equals(l,i)){l=F;m=A}else{var p=l[0].nodeType,q=p===D.NodeType.ELEMENT_NODE?l.nodeName():F;if(q&&l.attr("_ke_bookmark")){l=
l._4eNextSourceNode(A);continue}if(!q||g[q]&&(l._4ePosition(i)|E.POSITION_PRECEDING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(l))){var r=l.parent();if(r&&d==="a"&&r.nodeName()===d){p=j(this,c,void 0);r._4eMoveChildren(p);r[0].parentNode.replaceChild(p[0],r[0]);p._4eMergeSiblings()}else if(r&&r[0]&&((N[r.nodeName()]||N.span)[d]||f)&&(!e.parentRule||e.parentRule(r))){if(!o&&(!q||!N.$removeEmpty[q]||(l._4ePosition(i)|
E.POSITION_PRECEDING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED)){o=new H(c);o.setStartBefore(l)}if(p===D.NodeType.TEXT_NODE||p===D.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){r=l;for(p=null;(m=!r.next(s,1))&&(p=r.parent())&&g[p.nodeName()]&&(p._4ePosition(k)|E.POSITION_FOLLOWING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_FOLLOWING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(p));)r=
p;o.setEndAfter(r)}}else m=A}else m=A;l=l._4eNextSourceNode()}if(m&&o&&!o.collapsed){for(var m=j(this,c,void 0),r=o.getCommonAncestor(),p={},q={},t,u=null,w;m&&r&&m[0]&&r[0];){if(r.nodeName()===d){for(t in e.attributes)if(!q[t]&&(w=r.attr(u)))m.attr(t)===w?m.removeAttr(t):q[t]=1;for(u in e.styles)if(!p[u]&&(w=r.style(u)))m.style(u)===w?m.style(u,""):p[u]=1;if(!m._4eHasAttributes()){m=F;break}}r=r.parent()}if(m){m[0].appendChild(o.extractContents());a(this,m);o.insertNode(m);m._4eMergeSiblings();O.ie||
m[0].normalize()}else{m=n(c.createElement("span"));m[0].appendChild(o.extractContents());o.insertNode(m);a(this,m);m._4eRemove(true)}o=F}}k._4eRemove();i._4eRemove();b.moveToBookmark(h);b.shrink(v.SHRINK_TEXT)}}function t(a){a.enlarge(v.ENLARGE_ELEMENT);var d=a.createBookmark(),e=d.startNode;if(a.collapsed){for(var f=new I(e.parent()),g,h=0,i;h<f.elements.length&&(i=f.elements[h]);h++){if(i.equals(f.block)||i.equals(f.blockLimit))break;if(this.checkElementRemovable(i)){var j=a.checkBoundaryOfElement(i,
v.END),k=!j&&a.checkBoundaryOfElement(i,v.START);if(k||j){g=i;g.match=k?"start":"end"}else{i._4eMergeSiblings();if(i.nodeName()!==this.element){j=c(this);b(i,j[i.nodeName()]||j["*"])}else p(this,i)}}}if(g){i=e;for(h=0;;h++){j=f.elements[h];if(j.equals(g))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(i[0]);i=j}i[g.match==="start"?"insertBefore":"insertAfter"](g);f=g.html();!f||f==="\u200b"?g.remove():O.webkit&&n(a.document.createTextNode("\u200b")).insertBefore(i)}}else{var l=d.endNode,m=
this;g=function(){for(var a=new I(e.parent()),b=new I(l.parent()),c=F,d,f=F,g=0;g<a.elements.length;g++){d=a.elements[g];if(d===a.block||d===a.blockLimit)break;m.checkElementRemovable(d)&&(c=d)}for(g=0;g<b.elements.length;g++){d=b.elements[g];if(d===b.block||d===b.blockLimit)break;m.checkElementRemovable(d)&&(f=d)}f&&l._4eBreakParent(f);c&&e._4eBreakParent(c)};g();for(f=n(e[0].nextSibling);f[0]!==l[0];){h=f._4eNextSourceNode();if(f[0]&&f[0].nodeType===D.NodeType.ELEMENT_NODE&&this.checkElementRemovable(f)){if(f.nodeName()===
this.element)p(this,f);else{i=c(this);b(f,i[f.nodeName()]||i["*"])}if(h[0].nodeType===D.NodeType.ELEMENT_NODE&&h.contains(e)){g();h=n(e[0].nextSibling)}}f=h}}a.moveToBookmark(d)}function q(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function g(a,b){var c="";if(b!==J){c=document.createElement("span");c.style.cssText=a;c=c.style.cssText||""}else c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function c(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){k.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],f,g,h;if(typeof e==="string")f=e.toLowerCase();else{f=e.element?e.element.toLowerCase():a.element;g=e.attributes;h=e.styles}e=b[f]||(b[f]={});if(g){f=e.attributes=e.attributes||[];for(var i in g)f.push([i.toLowerCase(),g[i]])}if(h){var e=e.styles=e.styles||[],j;for(j in h)e.push([j.toLowerCase(),h[j]])}}}return b}
function p(a,b){var d=a._.definition,f=c(a),g=k.merge(d.attributes,(f[b.nodeName()]||f["*"]||{}).attributes),d=k.merge(d.styles,(f[b.nodeName()]||f["*"]||{}).styles),f=k.isEmptyObject(g)&&k.isEmptyObject(d),h;for(h in g)if(!((h==="class"||a._.definition.fullMatch)&&b.attr(h)!==e(h,g[h]))){f=f||!!b.hasAttr(h);b.removeAttr(h)}for(var i in d)if(!(a._.definition.fullMatch&&b.style(i)!==e(i,d[i],A))){f=f||!!b.style(i);b.style(i,"")}m(b)}function e(a,b,c){var d=n("<span>");d[c?"style":"attr"](a,b);return d[c?
"style":"attr"](a)}function a(a,d){for(var e=c(a),f=d.all(a.element),g=f.length;--g>=0;)p(a,n(f[g]));for(var h in e)if(h!==a.element){f=d.all(h);for(g=f.length-1;g>=0;g--){var i=n(f[g]);b(i,e[h])}}}function b(a,b){var c,d,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var f=e[c][0];if(d=a.attr(f)){var g=e[c][1];(g===F||g.test&&g.test(d)||typeof g==="string"&&d===g)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(c=0;c<e.length;c++){f=e[c][0];if(g=a.css(f)){var h=e[c][1];(h===F||h.test&&h.test(d)||
typeof h==="string"&&g===h)&&a.css(f,"")}}m(a)}function m(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4eRemove(A);if(b){b.nodeType===D.NodeType.ELEMENT_NODE&&D._4eMergeSiblings(b);c&&b!==c&&c.nodeType===D.NodeType.ELEMENT_NODE&&D._4eMergeSiblings(c)}}}var k=f("util"),i=f("./selection"),H=f("./range"),x=f("./base"),I=f("./element-path"),A=true,J=false,F=null,n=f("node"),D=f("dom"),v=x.RangeType,E=x.PositionType,K,O=f("ua"),P={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,
p:1,pre:1},N=x.XHTML_DTD,S={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;x.StyleType=K={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};o.prototype={constructor:o,apply:function(a){u.call(this,a,J)},remove:function(a){u.call(this,a,A)},applyToRange:function(a){return(this.applyToRange=this.type===K.STYLE_INLINE?z:this.type===K.STYLE_BLOCK?h:F).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===
K.STYLE_INLINE?t:F).call(this,a)},checkElementRemovable:function(a,b){if(!a)return J;var d,e=this._.definition,f;if(a.nodeName()===this.element){if(!b&&!a._4eHasAttributes())return A;var h=e._AC;if(!h){var h={},i=0,j=e.attributes;if(j)for(var k in j){i++;h[k]=j[k]}if(j=o.getStyleText(e)){h.style||i++;h.style=j}h._length=i;e._AC=h}e=h;if(e._length){for(d in e)if(d!=="_length"){i=a.attr(d)||"";if(d==="style")a:{h=e[d];i=g(i,J);typeof h==="string"&&(h=q(h));typeof i==="string"&&(i=q(i));j=void 0;for(j in h)if(!(j in
i&&(i[j]===h[j]||h[j]==="inherit"||i[j]==="inherit"))){h=J;break a}h=A}else h=e[d]===i;if(h){if(!b)return A}else if(b)return J}if(b)return A}else return A}d=c(this);if(d=d[a.nodeName()]||d["*"]){if(!(e=d.attributes)&&!(f=d.styles))return A;if(e)for(h=0;h<e.length;h++){d=e[h][0];if(d=a.attr(d)){i=e[h][1];if(i===F||typeof i==="string"&&d===i||i.test&&i.test(d))return A}}if(f)for(h=0;h<f.length;h++)if(d=a.css(f[h][0])){e=f[h][1];if(e===F||typeof e==="string"&&d===e||e.test&&e.test(d))return A}}return J},
checkActive:function(a){switch(this.type){case K.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,A);case K.STYLE_OBJECT:case K.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++){d=b[c];if(!(this.type===K.STYLE_INLINE&&(D.equals(d,a.block)||D.equals(d,a.blockLimit))))if((this.type!==K.STYLE_OBJECT||d.nodeName()in S)&&this.checkElementRemovable(d,A))return A}}return J}};o.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",
d="";c.length&&(c=c.replace(Q,";"));for(var e in b){var f=b[e],h=(e+":"+f).replace(Q,";");f==="inherit"?d=d+h:c=c+h}c.length&&(c=g(c));c=c+d;return a._ST=c};x.Style=o;y.exports=o});
KISSY.add("editor/dom-iterator","util,node,./walker,./range,./base,./element-path,ua,dom".split(","),function(x,f,C,y){function s(d){if(!(arguments.length<1)){this.range=d;this.forceBrBreak=w;this.enlargeBr=l;this.enforceRealBlocks=w;this._=this._||{}}}var r=f("util"),o=f("node"),u=f("./walker"),j=f("./range"),x=f("./base"),h=f("./element-path"),l=true,w=false,d=f("ua"),z=x.RangeType,t=f("dom"),q=/^[\r\n\t ]*$/;r.augment(s,{getNextParagraph:function(f){var c,p,e,a,b,m;if(!this._.lastNode){e=this.range.clone();
e.shrink(z.SHRINK_ELEMENT,l);e.enlarge(this.forceBrBreak||!this.enlargeBr?z.ENLARGE_LIST_ITEM_CONTENTS:z.ENLARGE_BLOCK_CONTENTS);p=new u(e);var k=u.bookmark(l,l);p.evaluator=k;this._.nextNode=p.next();p=new u(e);p.evaluator=k;p=p.previous();this._.lastNode=p._4eNextSourceNode(l);if(this._.lastNode&&this._.lastNode[0].nodeType===t.NodeType.TEXT_NODE&&!r.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()){k=new j(e.document);k.moveToPosition(this._.lastNode,z.POSITION_AFTER_END);
if(k.checkEndOfBlock()){k=new h(k.endContainer);this._.lastNode=(k.block||k.blockLimit)._4eNextSourceNode(l)}}if(!this._.lastNode){this._.lastNode=this._.docEndMarker=o(e.document.createTextNode(""));t.insertAfter(this._.lastNode[0],p[0])}e=null}k=this._.nextNode;p=this._.lastNode;for(this._.nextNode=null;k;){var i=w,s=k[0].nodeType!==t.NodeType.ELEMENT_NODE,x=w;if(s)k[0].nodeType===t.NodeType.TEXT_NODE&&q.test(k[0].nodeValue)&&(s=w);else{var y=k.nodeName();if(k._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){if(y==="br")s=l;else if(!e&&!k[0].childNodes.length&&y!=="hr"){c=k;a=k.equals(p);break}if(e){e.setEndAt(k,z.POSITION_BEFORE_START);if(y!=="br")this._.nextNode=k}i=l}else{if(k[0].firstChild){if(!e){e=new j(this.range.document);e.setStartAt(k,z.POSITION_BEFORE_START)}k=o(k[0].firstChild);continue}s=l}}if(s&&!e){e=new j(this.range.document);e.setStartAt(k,z.POSITION_BEFORE_START)}a=(!i||s)&&k.equals(p);if(e&&!i)for(;!k[0].nextSibling&&!a;){y=k.parent();if(y._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){i=l;a||y.equals(p);break}k=y;s=l;a=k.equals(p);x=l}s&&e.setEndAt(k,z.POSITION_AFTER_END);k=k._4eNextSourceNode(x,null,p);if((a=!k)||i&&e)break}if(!c){if(!e){this._.docEndMarker&&this._.docEndMarker._4eRemove();return this._.nextNode=null}c=new h(e.startContainer);k=c.blockLimit;i={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&i[k.nodeName()]&&e.checkStartOfBlock()&&e.checkEndOfBlock())c=k;else if(!c||this.enforceRealBlocks&&c.nodeName()==="li"){c=o(this.range.document.createElement(f||
"p"));c[0].appendChild(e.extractContents());c._4eTrim();e.insertNode(c);b=m=l}else if(c.nodeName()!=="li"){if(!e.checkStartOfBlock()||!e.checkEndOfBlock()){c=c.clone(w);c[0].appendChild(e.extractContents());c._4eTrim();m=e.splitBlock();b=!m.wasStartOfBlock;m=!m.wasEndOfBlock;e.insertNode(c)}}else if(!a)this._.nextNode=c.equals(p)?null:e.getBoundaryNodes().endNode._4eNextSourceNode(l,null,p)}if(b){e=o(c[0].previousSibling);e[0]&&e[0].nodeType===t.NodeType.ELEMENT_NODE&&(e.nodeName()==="br"?e._4eRemove():
e[0].lastChild&&t.nodeName(e[0].lastChild)==="br"&&t._4eRemove(e[0].lastChild))}if(m){e=u.bookmark(w,l);b=o(c[0].lastChild);b[0]&&b[0].nodeType===t.NodeType.ELEMENT_NODE&&b.nodeName()==="br"&&(d.ie||b.prev(e,1)||b.next(e,1))&&b.remove()}if(!this._.nextNode)this._.nextNode=a||c.equals(p)?null:c._4eNextSourceNode(l,null,p);return c}});j.prototype.createIterator=function(){return new s(this)};y.exports=s});
KISSY.add("editor/z-index-manager",["./base"],function(x,f,C,y){var s=f("./base"),x=s.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};s.baseZIndex=function(f){return(s.Config.baseZIndex||1E4)+f};y.exports=x});

/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 13 11:54
*/
KISSY.add("xtemplate/runtime",["util","logger-manager","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(p,h,o,l){function k(b,c,a){var f=b.fn;if(f.version&&KISSY.version!==f.version)throw Error("current xtemplate file("+b.name+")(v"+f.version+")need to be recompiled using current kissy(v"+KISSY.version+")!");a=b.fn(c,a);if(f=b.runtime.extendTplName)delete b.runtime.extendTplName,a=b.root.include(f,b,c,null,a);return a.end()}function i(a,f,g,e,d,m,j,k){var n;if(!m){n=a.runtime.commands;
var i=a.root.config.commands,h=d[0];n=n&&n[h]||i&&i[h]||c[h];if(1!==d.length&&n){i=d.length;for(h=1;h<i&&!(n=n[d[h]],!n);h++);}}if(n)return n.call(a,f,g,e,j);a="in file: "+a.name+" can not call: "+d.join(".")+'" at line '+j;if(k&&(f=f.resolve(d.slice(0,-1),m),d=f[d[d.length-1]]))return d.apply(f,g.params);a&&b.error(a);return e}function d(b,a){this.fn=b;a=this.config=a||{};a.loader=a.loader||e}function a(a,c){if("."!==a.charAt(0))return a;c||b.error("parent template does not have name for relative sub tpl name: "+
a);var f=m[c]=m[c]||{};if(f[a])return f[a];var d=a,g,e=a;g=c.split("/");e=e.split("/");g.pop();for(var j=0,k=e.length;j<k;j++){var i=e[j];"."!==i&&(".."===i?g.pop():g.push(i))}g=g.join("/");return a=f[d]=g}var p=h("util"),b=h("logger-manager"),o=h("./runtime/commands"),c={},f=h("./runtime/scope"),g=h("./runtime/linked-buffer"),j={callFn:function(a,b,c,f,g,d,e){return i(a,b,c,f,g,d,e,!0)},callCommand:function(a,b,c,f,g,d){return i(a,b,c,f,g,0,d,!0)}},e={load:function(a,c,f){h([c],{success:function(a){f(void 0,
a)},error:function(){var a='template "'+c+'" does not exist';b.log(a,"error");f(a)}})}};p.mix(d,{nativeCommands:o,utils:j,addCommand:function(a,b){c[a]=b},removeCommand:function(a){delete c[a]}});var m={};d.prototype={constructor:d,Scope:f,nativeCommands:o,utils:j,removeCommand:function(a){var b=this.config;b.commands&&delete b.commands[a]},addCommand:function(a,b){var c=this.config;c.commands=c.commands||{};c.commands[a]=b},include:function(b,c,f,g,d){var e=this,b=a(b,c.name);return d.async(function(a){e.config.loader.load(e,
b,function(d,e){d?a.error(d):"string"===typeof e?a.write(e,g&&g.escape).end():k({root:c.root,fn:e,name:b,runtime:c.runtime},f,a)})})},render:function(a,b,c){var d="",e=this.fn;"function"===typeof b&&(c=b,b=null);var b=b||{},c=c||function(a,b){d=b},j=this.config.name;!j&&e.TPL_NAME&&(j=e.TPL_NAME);a=new f(a);c=(new g(c)).head;k({name:j,fn:e,runtime:{commands:b.commands},root:this},a,c);return d}};d.Scope=f;l.exports=d});
KISSY.add("xtemplate/runtime/commands",["./scope","util"],function(p,h,o,l){var k=h("./scope"),i=h("util"),d={range:function(a,b){var c=b.params,f=c[0],d=c[1];if(c=c[2]){if(f>d&&0<c||f<d&&0>c)c=-c}else c=f>d?-1:1;for(var j=[],e=f;f<d?e<d:e>d;e+=c)j.push(e);return j},each:function(a,b,c){var f=b.params,d=f[0],j=f[2]||"xindex",f=f[1],e,m,h;if(d)if(i.isArray(d)){e=d.length;for(var l=0;l<e;l++)m=new k(d[l]),h=m.affix={xcount:e},h[j]=l,f&&(h[f]=d[l]),m.setParent(a),c=b.fn(m,c)}else for(e in d)m=new k(d[e]),
h=m.affix={},h[j]=e,f&&(h[f]=d[e]),m.setParent(a),c=b.fn(m,c);return c},"with":function(a,b,c){var d=b.params[0];d&&(d=new k(d),d.setParent(a),c=b.fn(d,c));return c},"if":function(a,b,c){b.params[0]?b.fn&&(c=b.fn(a,c)):b.inverse&&(c=b.inverse(a,c));return c},set:function(a,b,c){a.mix(b.hash);return c},include:function(a,b,c){var d=b.params,g,j=d.length;g=a;b.hash&&(g=new k(b.hash),g.setParent(a));for(a=0;a<j;a++)c=this.root.include(d[a],this,g,b,c);return c},parse:function(a,b,c){return d.include.call(this,
new k,b,c)},extend:function(a,b,c){this.runtime.extendTplName=b.params[0];return c},block:function(a,b,c){var d=this.runtime,g=b.params,j=g[0],e;2===g.length&&(e=g[0],j=g[1]);var g=d.blocks=d.blocks||{},h=g[j],b={fn:b.fn,type:e};if(h){if(h.type)if("append"===h.type)b.next=h,g[j]=b;else if("prepend"===h.type){var i;for(e=h;e&&"prepend"===e.type;)i=e,e=e.next;b.next=e;i.next=b}}else g[j]=b;if(!d.extendTplName)for(e=g[j];e;)e.fn&&(c=e.fn.call(this,a,c)),e=e.next;return c},macro:function(a,b,c,d){var a=
b.hash,g=b.params,h=g[0],g=g.slice(1),e=this.runtime,e=e.macros=e.macros||{};if(b.fn)e[h]={paramNames:g,hash:a,fn:b.fn};else{var b=e[h],h=b.hash||{},i;if(b&&(i=b.paramNames)){d=0;for(e=i.length;d<e;d++)h[i[d]]=g[d];if(a)for(var l in a)h[l]=a[l];i=new k(h);c=b.fn.call(this,i,c)}else throw Error("in file: "+this.name+" can not find macro: "+name+'" at line '+d);}return c}};l.exports=d});
KISSY.add("xtemplate/runtime/scope",[],function(p,h,o,l){function k(d){this.data=arguments.length?d:{};this.affix=i;this.root=this}var i;k.prototype={isScope:1,setParent:function(d){this.parent=d;this.root=d.root},set:function(d,a){this.affix||(this.affix={});this.affix[d]=a},setData:function(d){this.data=d},getData:function(){return this.data},mix:function(d){var a=this.affix;a||(a=this.affix={});for(var b in d)a[b]=d[b]},get:function(d){var a=this.data,b;b=(b=this.affix)&&b[d];if(b!==i)return b;
a!==i&&(b=a[d]);return b!==i?b:"this"===d?a:"root"===d?this.root.data:b},resolve:function(d,a){if(!a&&1===d.length)return this.get(d[0]);var b=d.length,c=this,f;if(b&&"root"===d[0])d.shift(),c=c.root,b--;else if(a)for(;c&&a--;)c=c.parent;if(!b)return c.data;var g=d[0];do f=c.get(g);while(f===i&&(c=c.parent));if(f&&c){for(c=1;f&&c<b;c++)f=f[d[c]];return f}return i}};l.exports=k});
KISSY.add("xtemplate/runtime/linked-buffer",["util"],function(p,h,o,l){function k(a){this.list=a;this.data=""}function i(a){this.head=new k(this);this.callback=a;this.data=""}var d=h("util");k.prototype={constructor:k,isBuffer:1,write:function(a,b){if(a||0===a)this.data+=b?d.escapeHtml(a):a;return this},async:function(a){var b=this.list,c=new k(b),b=new k(b);b.next=this.next;c.next=b;this.next=c;this.ready=!0;a(c);return b},error:function(a){var b=this.list.callback;b&&(b(a,void 0),this.list.callback=
null)},end:function(a,b){this.list.callback&&(this.write(a,b),this.ready=!0,this.list.flush());return this}};i.prototype={constructor:i,flush:function(){for(var a=this.head;a;){if(a.ready)this.data+=a.data;else return;this.head=a=a.next}this.callback(null,this.data)}};i.Buffer=k;l.exports=i});
